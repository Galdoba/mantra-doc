---
updated_at: 2026-02-21T01:12:27.704+10:00
---

| Key                     | /ping | /ws  | /login (POST) | /login (GET) | /web    | /   |
| ----------------------- | ----- | ---- | ------------- | ------------ | ------- | --- |
| Method                  | GET   | GET  | POST          | GET          | GET     | any |
| read_cookie_value?      | -     | +    | +             | +            | +       | -   |
| Read login/password?    | -     | -    | +             | -            | -       | -   |
| Set cookie?             | -     | -    | +             | -            | -       | -   |
| authenticate_by_cookie? | -     | +    | +             | +            | +       | -   |
| authorize?              | -     | +    | +             | -            | -       | -   |
| personal log?           | -     | +    | +             | +            | +       | -   |
| confirm_cookie_exists?  | -     | +    | !+            | !+           | +       | -   |
| return_code(s)          | 200   | many | 200/403       | 200/403      | 200/403 | 404 |

---
## Цепочки middleware для каждого эндпоинта

Для всех эндпоинтов первые два слоя являются обязательными и выполняются в следующем порядке:
1. **Logging** — фиксирует факт поступления запроса (метод, путь, время). По завершении обработки также логирует статус ответа.
2. **PanicRecovery** — перехватывает возможные паники, обеспечивает корректное завершение запроса и логирование ошибки.

Далее для каждого эндпоинта приведён пошаговый список действий (middleware/обработчиков) в порядке выполнения. Учтены все проверки из таблицы и логика, описанная ранее.

---

### Эндпоинт `/` (any method)
1. **Logging**
2. **PanicRecovery**
3. **Отправка ответа `404 Not Found`** (или любого другого, согласно таблице).  
   *Никаких дополнительных проверок не производится.*

---

### Эндпоинт `/ping` (GET)
1. **Logging**
2. **PanicRecovery**
3. **Отправка ответа `200 OK`** (например, с телом "pong").

---

### Эндпоинт `/web` (GET)
1. **Logging**
2. **PanicRecovery**
3. **Read cookie** — извлечение значения cookie из запроса.
4. **Authenticate by cookie** — проверка валидности сессии.  
   *Результат: объект пользователя (если аутентификация успешна) или `null`.*
5. **Personal log** — запись события:
   - Если пользователь аутентифицирован — в его личный лог: "Доступ к /web".
   - Если не аутентифицирован — в общий лог: "Доступ к /web без аутентификации".
6. **Перенаправление (redirect)**:
   - При успешной аутентификации — `302` на `/ws`.
   - При отсутствии аутентификации — `302` на `/login`.

---

### Эндпоинт `/login` (GET)
1. **Logging**
2. **PanicRecovery**
3. **Read cookie**
4. **Authenticate by cookie** — проверка наличия валидной сессии.
5. **Ветвление по результату аутентификации**:
   - **Если пользователь уже аутентифицирован** (cookie валидна):
     1. **Personal log** (личный): "Попытка доступа к форме входа при активной сессии".
     2. **Перенаправление** на `/web`.
   - **Если пользователь не аутентифицирован**:
     1. **Personal log** (общий): "Запрошена форма входа".
     2. **Отдача HTML-формы** (код `200 OK`).

---

### Эндпоинт `/login` (POST)
1. **Logging**
2. **PanicRecovery**
3. **Read cookie**
4. **Authenticate by cookie** — проверка наличия валидной сессии.
5. **Ветвление по результату аутентификации по cookie**:
   - **Если пользователь уже аутентифицирован**:
     1. **Personal log** (личный): "Повторная попытка входа (игнорируется)".
     2. **Перенаправление** на `/web`.
   - **Если пользователь не аутентифицирован**:
     1. **Read login/password** — извлечение учётных данных из тела запроса.
     2. **Authenticate by password** — проверка логина и пароля.
        - **Если аутентификация не пройдена**:
          1. **Personal log** (общий): "Неудачная попытка входа с логином X".
          2. **Возврат ошибки** (например, `401 Unauthorized` или редирект на `/login` с параметром ошибки).
        - **Если аутентификация пройдена** (получен объект пользователя):
          1. **Authorize** — проверка прав (активна ли учётная запись, есть ли доступ).
             - **Если авторизация не пройдена**:
               1. **Personal log** (личный): "Вход отклонён (недостаточно прав)".
               2. **Возврат ошибки `403 Forbidden`**.
             - **Если авторизация пройдена**:
               1. **Set cookie** — создание сессии и установка cookie в ответе.
               2. **Personal log** (личный): "Успешный вход".
               3. **Перенаправление** на `/web`.

---

### Эндпоинт `/ws` (GET — запрос на установку WebSocket)
1. **Logging**
2. **PanicRecovery**
3. **Read cookie**
4. **Authenticate by cookie** — проверка валидности сессии.
5. **Ветвление по результату аутентификации**:
   - **Если пользователь не аутентифицирован**:
     1. **Personal log** (общий): "Попытка подключения к WS без аутентификации".
     2. **Перенаправление** на `/web`.
   - **Если пользователь аутентифицирован**:
     1. **Authorize** — проверка прав на доступ к WebSocket (например, к конкретному каналу).
        - **Если авторизация не пройдена**:
          1. **Personal log** (личный): "Отказ в доступе к WS (недостаточно прав)".
          2. **Возврат ошибки `403 Forbidden`**.
        - **Если авторизация пройдена**:
          1. **Personal log** (личный): "Установка WS-соединения".
          2. **Выполнение handshake и переключение протокола** (код `101 Switching Protocols`).

---

### Примечания
- **Personal log** всегда пишется в момент, когда уже известно, аутентифицирован ли пользователь (или после аутентификации). Для неаутентифицированных действий используется общий лог-файл.
- Во всех случаях редиректа используется код `302 Found` (или `303 See Other` для POST-запросов, чтобы избежать повторной отправки формы).
- Порядок шагов гарантирует, что лишние операции (например, чтение тела запроса) не выполняются, если уже есть активная сессия.




## Диаграмма потока пользователя (User Flow Chart)

Ниже представлена блок-схема перемещений пользователя между эндпоинтами согласно описанной логике. Учтены все проверки, редиректы и возможные ветвления.

![[deepseek_mermaid_20260220_eb23a6.png]]


Пояснения к диаграмме
- **Начало**: пользователь заходит на сайт по любому URL.
- **Основные точки входа**:
  - `/web` — главная страница (редиректит на `/ws` или `/login`).
  - `/login GET` — форма входа.
  - `/login POST` — отправка учётных данных.
  - `/ws` — запрос на установку WebSocket.
  - `/ping` — health check.
  - `/` — любой другой путь (404).

- **Редиректы** (302) используются для навигации между страницами.
- **Личные логи** записываются на каждом этапе (на диаграмме не все показаны, но подразумеваются).
- **Выход (logout)** не выделен в отдельный эндпоинт, но может быть реализован через закрытие WebSocket или специальное сообщение внутри соединения (пунктирная линия).

### Ключевые пути

1. **Неаутентифицированный пользователь**:
   `/web` → `/login GET` → (ввод данных) → `/login POST` → при успехе → `/web` → `/ws` → соединение.

2. **Уже аутентифицированный пользователь**:
   - Прямой вход на `/web` или `/ws` ведёт сразу к `/ws`.
   - Попытка зайти на `/login` (GET или POST) редиректит на `/web`.

3. **Ошибки**:
   - Неверный пароль → возврат на `/login GET` с сообщением.
   - Недостаточно прав → 403.
   - Нет сессии при попытке подключиться к `/ws` → редирект на `/web`.

Диаграмма наглядно показывает, как система направляет пользователя в зависимости от состояния его сессии и прав.

