---
updated_at: 2026-01-28T15:30:44.096+10:00
tags:
  - package
---
# Пакет dice

`cepheus/pkg/dice`

## Назначение

Пакет `dice` предоставляет комплексную систему для парсинга и выполнения выражений бросков костей, характерных для настольных ролевых игр и других систем, требующих генерации случайных чисел по заданным формулам. Пакет фокусируется на точной интерпретации сложных нотаций бросков костей, оставляя аспекты управления таблицами и выбора результатов внешним компонентам.

## Возможности

### Основные возможности:
- **Суммарные броски (Roll)**: Вычисление суммы значений выпавших костей с применением сложных модификаторов
- **Конкатенированные броски (ConcatRoll)**: Объединение результатов нескольких костей в строковое представление (например, для процентных бросков)
- **Богатый синтаксис выражений**: Поддержка широкого спектра модификаторов:
  - Арифметические операции (сложение, вычитание, умножение, деление)
  - Замены значений (переопределение конкретных результатов)
  - Перебросы (повторные броски при выпадении определённых значений)
  - Отбрасывание экстремальных значений (самых высоких/низких)
  - Индивидуальные модификаторы для каждой кости
  - Ограничители (минимальное/максимальное значение суммы)
- **Детерминированная генерация**: Поддержка явного сидирования для воспроизводимых результатов
- **Интерфейсная архитектура**: Возможность интеграции с различными системами через интерфейс `Roller`

### Дополнительные возможности:
- **Комплексный парсинг**: Единовременный парсинг выражений с валидацией и обработкой ошибок
- **Состояние бросков**: Сохранение истории последних бросков для отладки и анализа
- **Специальные броски**: Встроенные функции для распространённых игровых механик (Flux, D66)
- **Гибкость использования**: Как standalone-функции, так и методы экземпляров Roller

## Преимущества перед аналогами

### По сравнению с простыми генераторами случайных чисел:
- **Богатый синтаксис**: Поддержка сложных выражений вместо простых "NdM"
- **Комплексные модификаторы**: Встроенная поддержка перебросов, замен, отбрасываний и ограничителей
- **Строгая валидация**: Детальная проверка выражений на корректность до выполнения

### По сравнению с другими библиотеками бросков костей:
- **Два режима бросков**: Одновременная поддержка суммарных и конкатенированных бросков
- **Полнота нотации**: Поддержка редких, но полезных модификаторов (индивидуальные модификаторы, деление)
- **Детерминизм**: Чёткая система сидирования для воспроизводимости результатов
- **Обработка ошибок**: Детальные сообщения об ошибках парсинга и выполнения

### Архитектурные преимущества:
- **Разделение парсинга и выполнения**: Чёткое разделение фазы анализа выражения и фазы генерации
- **Объектно-ориентированный и функциональный подходы**: Поддержка обоих стилей использования
- **Расширяемость**: Возможность добавления новых типов модификаторов без изменения ядра

## Сценарии использования

### В настольных ролевых играх:
- **Стандартные броски атрибутов**: Выражения типа "3d6", "4d6dl1" (броски характеристик)
- **Сложные боевые механики**: Броски урона с перебросами, ограничителями и модификаторами
- **Процентные системы**: Конкатенированные броски для навыков и проверок
- **Специальные механики**: Системы Flux для хаотических эффектов, D66 для таблиц

### В компьютерных играх:
- **Генерация случайных значений**: Сложные формулы для урона, лечения, ресурсов
- **Системы проклятий/благословений**: Динамические модификаторы на основе состояния игрока
- **Детерминированная генерация**: Воспроизводимые случайные события для отладки и тестирования

### В инструментах для разработки игр:
- **Прототипирование механик**: Быстрое тестирование различных формул бросков
- **Балансировка систем**: Анализ распределений результатов сложных выражений
- **Документирование правил**: Единый синтаксис для описания игровых механик

### В симуляциях и тестировании:
- **Моделирование вероятностных систем**: Анализ распределений результатов сложных выражений
- **Нагрузочное тестирование**: Массовая генерация бросков для проверки стабильности
- **Верификация правил**: Проверка соответствия реализаций игровым правилам

## Ограничения

### Функциональные ограничения:
- **Целочисленная арифметика**: Все операции выполняются с целыми числами
- **Линейный порядок модификаторов**: Определённый порядок применения модификаторов (перебросы → замены → индивидуальные → отбрасывания → суммарные)
- **Ограниченные типы костей**: Поддержка только стандартных многогранных костей

### Архитектурные ограничения:
- **Статический парсинг**: Отсутствие поддержки динамических выражений (нельзя изменять выражение во время выполнения)
- **Отсутствие потокобезопасности**: Экземпляры Roller не предназначены для конкурентного использования без внешней синхронизации
- **Фиксированный набор модификаторов**: Невозможность добавления пользовательских модификаторов без изменения кода

### Практические ограничения:
- **Производительность парсинга**: Регулярные выражения и однопроходный парсинг могут быть затратными для очень частых бросков
- **Память для состояния**: Сохранение результатов последнего броска увеличивает потребление памяти
- **Ограниченная расширяемость синтаксиса**: Добавление новых типов модификаторов требует изменения парсера

## Возможности расширения

### Легко расширяемые компоненты:

1. **Новые типы модификаторов**:
   - Добавление статистических операций (медиана, мода)
   - Поддержка условных модификаторов
   - Взвешенные кости или нестандартные распределения

2. **Расширенный синтаксис**:
   - Вложенные выражения и арифметические приоритеты
   - Переменные и константы в выражениях
   - Функции (логарифмы, степени, округления)

3. **Интеграционные расширения**:
   - Адаптеры для различных ГПСЧ (CSPRNG, распределённые генераторы)
   - Плагины для игровых движков и фреймворков
   - Веб-интерфейс для удалённого выполнения бросков

4. **Инструменты анализа**:
   - Генерация гистограмм распределений
   - Статистический анализ выражений
   - Оптимизация формул под заданные распределения

5. **Оптимизации производительности**:
   - Кэширование разобранных выражений
   - Пакетная обработка бросков
   - JIT-компиляция часто используемых выражений

## Заключение

Пакет `dice` предоставляет мощную, но специализированную систему для работы с выражениями бросков костей, характерными для игровой индустрии и симуляций. Его архитектура делает упор на точность интерпретации сложных нотаций, детерминированность результатов и удобство интеграции с другими системами.

Пакет идеально подходит для сценариев, где требуется точное соответствие формальным правилам бросков костей, поддержка сложных модификаторов и воспроизводимость результатов. Однако он не предназначен для систем, требующих произвольной арифметики с плавающей точкой, динамических выражений или экстремальной производительности при миллионах бросков.

Расширение функциональности пакета возможно как через добавление новых типов модификаторов в существующий синтаксис, так и через создание надстроек, предоставляющих дополнительные инструменты анализа и оптимизации. Чёткое разделение парсинга и выполнения обеспечивает хорошую основу для будущего развития.