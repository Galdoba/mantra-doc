---
updated_at: 2026-02-12T14:28:38.895+10:00
---
**Идентификатор корреляции** ({{Correlation ID|correlation id}}) — это уникальный токен, присваиваемый операции, запросу или бизнес-процессу на входе в распределённую систему и последовательно передаваемый через все компоненты, сервисы и асинхронные вызовы, участвующие в обработке этого процесса. Он позволяет связать воедино разрозненные записи логов, трассировки и метрики, порождаемые различными сервисами в ходе выполнения единого сценария.

### Назначение
Идентификатор корреляции является краеугольным камнем наблюдаемости в микросервисных и событийно-ориентированных архитектурах:

*   **Сквозная трассировка ([[Distributed Tracing|distributed tracing]])**. Восстановление полного пути запроса через десятки сервисов, определение времени, проведённого в каждом компоненте, и выявление узких мест.
*   **Корреляция логов**. Связывание структурированных записей логов от разных сервисов, относящихся к одному пользовательскому запросу или бизнес-процессу, что позволяет диагностировать инциденты без ручного перебора.
*   **Дедупликация и идемпотентность**. Использование идентификатора корреляции в качестве ключа идемпотентности для обнаружения повторных запросов и отбрасывания дубликатов.
*   **Аудит и расследование**. Быстрый поиск всех событий, связанных с конкретным заказом, пользователем или транзакцией, в системах хранения логов и событий.
*   **Мониторинг и оповещение**. Группировка метрик по идентификатору корреляции позволяет анализировать качество обслуживания в разрезе отдельных сценариев.

### Ограничения
Применение идентификаторов корреляции сопряжено с рядом практических ограничений:

1.  **Необходимость явной передачи контекста**. Разработчик должен гарантировать, что идентификатор корреляции пробрасывается через все синхронные вызовы (HTTP, gRPC) и асинхронные сообщения. Пропуск передачи разрывает цепочку и разрушает наблюдаемость.
2.  **Совместимость форматов**. В разнородной среде (разные языки, протоколы, брокеры) необходимо согласование единого формата идентификатора и способа его передачи, иначе корреляция между компонентами становится невозможной.
3.  **Производительность и хранение**. Генерация, парсинг и логирование идентификатора добавляют накладные расходы. В системах с экстремально высокой пропускной способностью даже несколько наносекунд на операцию могут быть значимы.
4.  **Долговременное хранение**. Для целей аудита и расследований идентификаторы корреляции должны сохраняться вместе с логами и событиями, что увеличивает объём хранимых данных.
5.  **Безопасность**. Злоумышленник может подделать или подменить идентификатор корреляции, внедряя ложные данные в заголовки запросов. Требуется валидация и, при необходимости, криптографическая верификация.

### Сложившиеся практики
Индустрия выработала устойчивые подходы к внедрению и использованию идентификаторов корреляции:

1.  **Использование открытых стандартов**. Повсеместно принят стандарт [[W3C Trace Context|W3C Trace Context]], определяющий заголовки `traceparent` и `tracestate`. Он обеспечивает совместимость между различными системами трассировки и библиотеками инструментирования.

2.  **Интеграция с [[OpenTelemetry]]**. OpenTelemetry предоставляет единый, поставщико-независимый API для генерации, передачи и извлечения контекста трассировки. Практика заключается во внедрении OpenTelemetry во все сервисы, что автоматизирует проброс идентификатора корреляции.

3.  **Автоматическая генерация на границе системы**. Идентификатор корреляции создаётся при первом входе запроса в систему — в [[API Gateway|API-шлюзе]], балансировщике нагрузки или первом сервисе, принимающем внешний вызов. Если клиент уже предоставил идентификатор, он может быть принят при условии валидации формата.

4.  **Явный проброс через заголовки протоколов**:
    *   В HTTP-запросах — стандартные заголовки `X-Request-ID`, `X-Correlation-ID` или `traceparent`.
    *   В асинхронных сообщениях (Kafka, RabbitMQ) — поля заголовков сообщений.
    *   В gRPC — метаданные.
    *   Внутри процессов — использование локальных контекстов выполнения ([[Thread-local storage|thread-local]], асинхронные контексты).

5.  **Включение в структурированные логи**. Идентификатор корреляции обязательно добавляется в каждую запись лога как отдельное поле (например, `correlation.id`). Это позволяет выполнять фильтрацию и поиск по идентификатору в системах централизованного сбора логов (Loki, Elasticsearch).

6.  **Передача в исходящие вызовы**. При обращении к внешним системам, не поддерживающим стандартные заголовки, идентификатор корреляции передаётся в согласованном проприетарном заголовке или, в крайнем случае, записывается в тело запроса.

7.  **Логирование идентификатора при входе и выходе**. Каждый сервис логирует факт получения запроса с указанием идентификатора корреляции и факт завершения обработки. Это создаёт видимые «точки входа и выхода» для каждого компонента.

8.  **Дедупликация и идемпотентность**. Идентификатор корреляции используется как ключ идемпотентности: сервер запоминает обработанные идентификаторы и при повторном запросе возвращает ранее сохранённый ответ, не выполняя операцию повторно.

9.  **Мониторинг на основе корреляции**. Метрики (задержка, частота ошибок) агрегируются не только по сервисам, но и по типам операций, идентифицируемым по идентификатору корреляции. Это позволяет отслеживать качество обслуживания конкретных бизнес-сценариев.

10. **Валидация и безопасность**. При приёме внешнего идентификатора корреляции выполняется его проверка на соответствие формату (обычно UUIDv4) и, при необходимости, на принадлежность доверенному источнику. В чувствительных средах идентификаторы могут подписываться.

11. **Тестирование корреляции**. В тестовые сценарии включаются проверки, что идентификатор корреляции, сгенерированный на входе, присутствует в логах всех задействованных сервисов и трассировках.

Таким образом, идентификатор корреляции является элементарным, но критически важным механизмом для обеспечения наблюдаемости в распределённых системах. Его последовательное применение превращает хаос разрозненных событий и логов в связную, диагностируемую картину выполнения бизнес-процессов. Дисциплина проброса идентификатора корреляции должна быть неотъемлемой частью инженерной культуры, поддерживаемой на уровне фреймворков, инфраструктурных компонентов и код-ревью.