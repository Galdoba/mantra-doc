---
updated_at: 2025-12-15T13:22:55.967+10:00
tags:
---

В предыдущей главе говорилось, что для успеха проекта крайне важно разработать единый язык (ubiquitous language), предназначенный для общения представителей всех заинтересованных сторон (stakeholders), от разработчиков программного продукта до экспертов предметной области. Язык должен отражать ментальные модели экспертов предметной области, раскрывающие внутренние механизмы ее работы и принципы, положенные в основу этой работы. 
Поскольку наша цель заключается в использовании единого языка для принятия решений по проектированию программного продукта, язык должен быть ясным и непротиворечивым. В нем не должно быть двояких толкований, скрытых предположений и деталей, не имеющих никакого отношения к делу. Но в масштабе организации, ментальные модели экспертов предметной области могут сами по себе быть противоречивыми. Разными экспертами предметной области могут использоваться разные модели одной и той же сферы деятельности. Рассмотрим на примере.

## Противоречивые модели 
Вернемся к примеру с телемаркетинговой компанией из *главы 2*. Маркетинговый отдел компании привлекает потенциальных клиентов с помощью онлайн-рекламы. А отдел продаж этой компании отвечает за привлечение потенциальных клиентов к покупке его продуктов или услуг, при этом выстраивается цепочка, показанная на рис. 3.1.

![[Рис. 3.1. Пример предметной области телемаркетинговая компания.png]]

При изучении языка, используемого экспертами предметной области, наблюдается странная особенность. Термин «lead» в отделах маркетинга и продаж имеет разные значения:
*Отдел маркетинга* 
	Для маркетологов «lead» представляется уведомлением о чьей-то заинтересованности в одном из продуктов. Под словом «lead» подразумевается событие получения контактных данных потенциального клиента. 
*Отдел продаж* 
	Для специалистов отдела продаж слово «lead» представляет собой гораздо более сложную сущность. Под ним подразумевается весь жизненный цикл процесса продаж. И это уже не просто событие, а весьма продолжительный процесс. 
И как тогда в этой компании сформировать единый язык? 
С одной стороны, понятно, что единый язык не должен содержать никаких противоречий, т. е. у каждого понятия должно быть одно-единственное значение. А с другой стороны, известно, что единый язык должен отражать ментальные модели экспертов предметной области. Получается, что ментальная модель понятия «lead» у экспертов предметной области в отделах продаж и маркетинга разная. 
Эта неоднозначность не создает особых проблем при личном общении, но может создавать сложности при общении сотрудников разных отделов, но людям совсем нетрудно понять точное значение данного термина из контекста обсуждаемого вопроса. 
Но отразить такую противоречивую модель предметной области в сфере разработки программного продукта гораздо сложнее. Справиться с неоднозначностью в исходном коде порой весьма нелегко. Если перенести модель отдела продаж в предметную область маркетинга, сложность возникла бы там, где она совершенно не нужна, — получилось бы гораздо больше подробностей и особенностей поведения, чем нужно маркетологам для оптимизации рекламных кампаний. Но если попытаться упростить модель отдела продаж в соответствии с трактовкой этого термина маркетинговым отделом, она перестала бы соответствовать потребностям поддомена (subdomain) продаж из-за слишком упрощенного взгляда на управление и оптимизацию процесса продаж. В первом случае получилось бы слишком сложное решение, а во втором оно бы не удовлетворяло всем требованиям. 
Как же разрешить эту «Уловку-22»? 
Традиционное решение заключается в разработке единой модели, подходящей для всех типов задач. Такие модели превращаются в огромные диаграммы отношений сущностей (entity relationship diagrams, ERD) размером со всю стену офиса. А является ли то, что показано на рис. 3.2, эффективной моделью? 
Как говорится, «обо всем и ни о чем». Предполагается, что такие модели подходят для всего, но в конечном итоге они не эффективны ни для чего. В любом случае придется сталкиваться со сложностями: сложностью избавления от ненужных подробностей, сложностью поиска действительно необходимого и, самое главное, сложностью поддержания данных в непротиворечивом состоянии.
Другим решением может быть добавление к проблемному термину префикса с именем контекста: «marketing lead» («маркетинговый lead») и «sales lead» («продажный lead»). Это позволило бы реализовать в коде сразу две модели. Но у данного подхода два основных недостатка: 
- Во-первых, это когнитивная нагрузка. Когда какую из моделей нужно использовать? Чем ближе реализации конфликтующих моделей, тем легче ошибиться. 
- Во-вторых, реализация модели не будет соответствовать единому языку. Никто не будет пользоваться префиксами в разговорах. Людям эта дополнительная информация не нужна; они смогут обходиться контекстом разговора.

![[Рис. 3.2. Диаграмма отношений сущностей в масштабе предприятия.png]]

Давайте обратимся к паттерну (pattern) предметно-ориентированного проектирования, предназначенному для решения подобных сценариев: ограниченному контексту (bounded context).

### Что такое ограниченный контекст? 
Данная проблема в предметно-ориентированном проектировании решается весьма тривиально: нужно разбить единый язык на несколько меньших по объему языков, а затем назначить каждому из них явный контекст применения: его ограниченный контекст. 
В предыдущем примере можно выделить два ограниченных контекста: маркетинг и продажи. Как показано на рис. 3.3, термин «lead» имеется в обоих ограниченных контекстах. Пока в каждом ограниченном контексте у него одно-единственное значение, каждый, более конкретный единый язык непротиворечив и следует ментальным моделям экспертов предметной области. 
В той или иной степени терминологические конфликты и неявно выраженные контексты являются неотъемлемой частью любого более-менее крупного бизнеса. В паттерне ограниченного контекста сами контексты моделируются как явная и неотъемлемая часть предметной области.

![[Рис. 3.3. Устранение противоречивости в едином языке путем разбиения его на ограниченные контексты.png]]

### Границы модели 
В предыдущей главе уже говорилось, что модель является не копией реального мира, а концептом, помогающим разобраться в сложной системе. Решаемая с ее помощью задача является неотъемлемой частью модели — ее назначением. Модель не может существовать без границ, иначе модель расширится до копии реального мира. Это делает определение границ модели — ее ограниченных контекстов — неотъемлемой частью процесса моделирования. 
Вернемся к тому примеру, где в качестве моделей рассматривались карты. В нем было показано, что у каждой карты имеется свой особый контекст — воздушный, морской, ландшафтный, метро и т. д. Карта полезна и непротиворечива только в рамках ее конкретного предназначения. 
Точно так же, как карта метро бесполезна для морской навигации, единый язык в одном ограниченном контексте может быть совершенно неуместен в другом ограниченном контексте. Ограниченные контексты определяют сферу применения единого языка и представляемой им модели. Они позволяют определять различные модели в соответствии с различными областями задач (problem domain). Иными словами, ограниченные контексты — это границы согласованности единых языков. Терминология, принципы и бизнес-правила языка согласуются только внутри его ограниченного контекста. 

### Уточнение термина «единый язык» 
Ограниченные контексты позволяют завершить определение единого языка (ubiquitous language). Единый язык не является «единым» в том смысле, что он должен использоваться и применяться повсеместно во всей организации. Единый язык не является универсальным. 
Единый язык применим только в границах своего ограниченного контекста. Язык ориентирован на описание только той модели, которая заключена в ограниченный контекст. Поскольку модель не может существовать без задачи, для решения которой она предназначена, единый язык не может быть определен или использован без явного контекста его применимости.

### Область применения ограниченного контекста 
Пример в начале главы продемонстрировал границу, свойственную предметной области. Различные эксперты предметной области придерживались противоречивых ментальных моделей одного и того же бизнес-объекта. Чтобы смоделировать предметную область, пришлось разделить модель и определить строгий контекст применимости для каждой более конкретизированной модели — ее ограниченный контекст. 
Непротиворечивость единого языка помогает определить только самую широкую границу его применения. Она не может быть еще шире, поскольку тогда мы получим несогласованные модели и терминологию. Но, как показано на рис. 3.4, модели можно разбить на еще более мелкие ограниченные контексты.

![[Рис. 3.4. Еще меньшие ограниченные контексты.png]]

Определение области применения единого языка — его ограниченного контекста — является стратегическим проектным решением. Границы могут быть широкими, в соответствии с контекстами самой предметной области, или узкими, при разделении предметной области на менее крупные области задач. 
Размер ограниченного контекста сам по себе не является решающим фактором. Модели не обязательно должны быть большими или маленькими. Они должны быть полезными. Чем шире границы единого языка, тем труднее сохранить его непротиворечивость. Порой будет выгоднее разбить большой единый язык на более мелкие и более управляемые области задач, но стремление к небольшим ограниченным контекстам также может иметь и неприятные последствия. Чем мельче ограниченные контексты, тем выше издержки на интеграцию несет такой дизайн.
Следовательно, решение о выборе размеров ограниченных контекстов должно зависеть от конкретной предметной области. Иногда понятнее будет использование широких границ, а иногда целесообразнее будет заняться дальнейшим разбиением на более мелкие ограниченные контексты. 
Причиной выделения более мелких ограниченных контекстов из более крупного может стать подключение к разработке новых команд разработчиков ПО или удовлетворение ряда нефункциональных требований системы, к примеру, при возникновении потребности в разделении жизненных циклов разработки некоторых компонентов, изначально находящихся в одном ограниченном контексте. Еще одна весьма распространенная причина выделения одной из функций заключается в возможности ее масштабирования независимо от остальных функций ограниченного контекста. 
Поэтому нужно сделать так, чтобы модели были полезными, а размеры ограниченных контекстов соответствовали потребностям вашего бизнеса и организационным ограничениям. Но при этом нужно избегать разбиения связанной функциональности на несколько ограниченных контекстов. Такое разбиение помешает независимому развитию каждого контекста. Ведь одинаковые бизнес-требования и изменения будут оказывать на ограниченные контексты одновременное влияние и требовать единомоментного развертывания новых версий. Чтобы избежать такой неэффективной декомпозиции, нужно следовать эмпирическому правилу, которое рассматривалось в главе 1 для поиска поддоменов: определите наборы связанных сценариев использования (coherent use cases), которые работают с одними и теми же данными, и избегайте их разбиения на несколько ограниченных контекстов. 
Тема непрерывной оптимизации границ ограниченных контекстов будет рассмотрена далее в *главах 8* и *10*.

### Сравнение ограниченных контекстов и поддоменов 
В *главе 2* говорилось, что предметная область состоит из нескольких поддоменов. До сих пор в текущей главе исследовалось понятие разбиения предметной области на набор более мелких областей задач или ограниченных контекстов. На первый взгляд два метода разбиения предметных областей могут показаться излишними. Но это не так. Давайте рассмотрим, зачем нам нужны оба разграничения.

#### Поддомены 
Чтобы понять бизнес-стратегию компании, нужно проанализировать ее предметную область. В соответствии с методологией предметно-ориентированного проектирования этап анализа включает в себя определение различных поддоменов (основных (core), универсальных (generic) и вспомогательных (supporting)). Именно так работает и планирует свою конкурентную стратегию та или иная организация.
В главе 1 говорилось, что поддомен похож на набор взаимосвязанных сценариев использования (use cases). Эти сценарии определяются предметной областью и системными требованиями. Разработчиками программных продуктов требования не определяются, это прерогатива бизнеса. А разработчики, чтобы идентифицировать поддомен, анализируют предметную область.

#### Ограниченные контексты 
А вот ограниченные контексты определяются в процессе проектирования. Выбор границ моделей является стратегическим решением проектирования. Проектировщики решают, как разбить предметную область (business domain) на более мелкие, управляемые области задач (problem domains).

#### Взаимодействие поддоменов и ограниченных контекстов 
Теоретически, хотя это и непрактично, одна модель может охватывать всю предметную область. Эта стратегия, как показано на рис. 3.5, может сработать для небольшой системы.

![[Рис. 3.5. Монолитный ограниченный контекст.png]]

Когда появляются конфликтующие модели, можно следовать ментальным моделям экспертов предметной области и, как показано на рис. 3.6, разбивать системы на ограниченные контексты. 

![[Рис. 3.6. Ограниченные контексты, обусловленные непротиворечивостью единого языка.png]]

Если модели все еще слишком большие и их трудно поддерживать, можно разбить их на еще более мелкие ограниченные контексты, получив, к примеру, как показано на рис. 3.7, ограниченный контекст для каждого поддомена. 
В любом случае это решение проектирования (design decision), частью которого и является определение границ. 
Однозначная взаимозависимость ограниченных контекстов и поддоменов может быть вполне разумной для целого ряда сценариев. Но бывает, что могут подойти и другие стратегии разбиений.

![[Рис. 3.7. Ограниченные контексты, совпадающие с границами поддоменов.png]]

Крайне важно помнить, что поддомены выявляются, а ограниченные контексты проектируются. Поддомены определяются бизнес-стратегией. Но программное решение и его ограниченные контексты могут быть спроектированы с учетом конкретного проекта и ограничений. 
И наконец, как говорилось в главе 1, модель предназначена для решения конкретной задачи. В ряде случаев для решения разных задач может оказаться полезным одновременное использование сразу нескольких моделей одной и той же концепции. Как и разные типы карт предоставляют разную информацию о нашей планете, так может быть разумно воспользоваться разными моделями одного и того же поддомена для решения разных задач. Ограничение дизайна однозначной взаимозависимостью между ограниченными контекстами помешало бы этой гибкости и вынудило бы воспользоваться единой моделью поддомена в ее ограниченном контексте.

## Границы 
Как говорит Рут Малан (Ruth Malan), архитектурное проектирование по своей сути связано с границами: 
Архитектурное проектирование — это системное проектирование. А системное проектирование — это контекстуальное проектирование, и оно по своей сути касается границ (что будет внутри, что снаружи, что будет охватывать, а что перемещаться через границы) и компромиссов. Оно изменяет то, что снаружи точно так же, как он формирует то, что внутри . 
Ограниченный контекст — это управляемый предметной областью инструмент проектирования для определения физических границ и границ владения. 

### Физические границы 
Ограниченные контексты служат не только границами модели, но и физическими границами реализующих их систем. Каждый ограниченный контекст должен быть реализован как отдельный сервис или проект, т. е. он реализуется, развивается и версионируется независимо от других ограниченных контекстов. 
Четкие физические границы между ограниченными контекстами позволяют реализовывать каждый ограниченный контекст с помощью технологического стека, наиболее соответствующего его потребностям. 
Как уже ранее говорилось, ограниченный контекст может содержать сразу несколько поддоменов. В таком случае ограниченный контекст является физической границей, а у каждого его поддомена имеются логические границы, имеющие в разных языках программирования разные имена: пространства имен, модули или пакеты. 

### Границы владения 
Исследования показывают, что хорошие заборы способствуют добрососедским отношениям. В программных проектах для мирного сосуществования команд можно воспользоваться границами моделей — ограниченными контекстами. Распределение работы между командами — еще одно стратегическое решение, которое может приниматься с использованием паттерна ограниченного контекста. 
Ограниченный контекст должен реализовываться, развиваться и поддерживаться только одной командой. Никакие две команды не могут работать над одним и тем же ограниченным контекстом. Это разделение устраняет неявные предположения, которые могут формироваться у команд в отношении моделей друг друга. Команды должны явно определять протоколы обмена данными для интеграции своих моделей и систем.
Важно отметить однозначность отношений между командами и ограниченными контекстами: ограниченный контекст должен принадлежать только одной команде. Но, как показано на рис. 3.8, одна команда может владеть сразу несколькими ограниченными контекстами.

![[Рис. 3.8. Команда 1 работает с ограниченным контекстом маркетинга и оптимизации, а команда 2 работает с ограниченным контекстом продаж.png]]

### Ограниченные контексты в реальной жизни 
На одном из моих занятий по предметно-ориентированному проектированию один из присутствующих однажды заметил: «Вы сказали, что DDD — это приведение дизайна программного продукта в соответствие с предметными областями. Но где можно увидеть ограниченные контексты в реальной жизни? В предметных областях нет ограниченных контекстов». 
Ограниченные контексты действительно не столь очевидны, как предметные области и поддомены, но они существуют, как и ментальные модели экспертов предметной области. Вам просто нужно понимать, как эксперты предметной области размышляют о различных бизнес-сущностях и процессах. 
Я хочу завершить эту главу рассмотрением примеров, демонстрирующих, что ограниченные контексты получили широкое распространение не только при моделировании предметных областей в программных продуктах, но и при представлении о том, как различные модели используются в разных контекстах в реальной жизни.

#### Семантические области 
Можно сказать, что ограниченные контексты предметно-ориентированного проектирования основаны на лексикографическом понятии семантических областей (semantic domain). Семантическая область определяется как область значений и слов, используемых для того, чтобы вести речь об ограниченном контексте. Например, в семантических областях разработки программного и аппаратного обеспечения такие слова, как «монитор», «порт» и «процессор», имеют разные значения. 
Весьма своеобразным примером разных семантических областей является значение слова «помидор». 
Согласно определению, используемому в ботанике, фрукт является способом распространения растениями своих семян. Фрукт должен вырасти из цветка растения и нести в себе хотя бы одно семя. С другой стороны, овощ является общим термином, охватывающим все другие съедобные части растения: корни, стебли и листья. Исходя из этого определения, помидор — это фрукт. 
Но это определение совершенно не подходит в контексте кулинарного искусства. В этом контексте фрукты и овощи определяются на основе их вкусовых характеристик. Фрукты имеют мягкую структуру, бывают сладкими или кислыми, их можно есть в сыром виде, а овощи имеют более жесткую структуру, менее выраженный вкус и часто требуют приготовления. Согласно этому определению помидор является овощем. 
Следовательно, в ограниченном контексте ботаники помидор — это фрукт, а в ограниченном контексте кулинарного искусства — овощ. Но это еще не все. 
В 1883 году США установили 10-процентный налог, распространяемый на ввозимые овощи, но не на фрукты. Ботаническое определение помидора как фрукта позволяло ввозить помидоры в Соединенные Штаты без уплаты налога на импорт. Чтобы закрыть лазейку, в 1893 году Верховный суд США принял решение классифицировать помидоры как овощи. Следовательно, в ограниченном контексте налогообложения помидор является овощем. 
Кроме того, как говорит мой друг Роме Моура (Romeu Moura), в ограниченном контексте театрального представления помидор является механизмом зрительского отклика.

#### Наука 
Историк Юваль Ной Харари (Yuval Noah Harari) как-то сказал: «Ученые в целом согласны с тем, что ни одна теория не является на 100% верной. Таким образом, знания по-настоящему проверяются приносимой ими пользой, а не их истинностью». Иными словами, ни одна научная теория не будет корректной абсолютно во всех случаях. Разные теории полезны в разных контекстах. 
Это понятие можно продемонстрировать с помощью различных моделей гравитации, представленных сэром Исааком Ньютоном и Альбертом Эйнштейном. Согласно законам движения Ньютона, пространство и время абсолютны. Они являются сценой, на которой происходит движение объектов. В теории относительности Эйнштейна пространство и время больше не абсолютны, а различны для разных наблюдателей. 
Несмотря на то что эти две модели можно рассматривать как противоречащие друг другу, обе они полезны в своих подходящих (ограниченных) контекстах.

#### Покупка холодильника 
И наконец, давайте рассмотрим более приземленный пример реальных ограниченных контекстов. Что вы видите на рис. 3.9?

![[Рис. 3.9. Кусок картона.png]]

Это простой кусок картона? Нет, это модель. Причем модель холодильника Siemens KG86NAI31L. При ближайшем рассмотрении можно сказать, что кусок картона совсем не похож на указанный холодильник. У него отсутствуют дверцы и даже цвет у него другой. 
Пусть все это так и есть, но это не важно. Как уже говорилось, модель не должна копировать реальный объект. У нее вместо этого должна быть цель — задача, которую с ее помощью нужно решить. Следовательно, правильным вопросом о картоне будет следующий: какую задачу помогает решить эта модель? 
В нашей квартире нестандартный вход на кухню. Картон вырезали точно по ширине и глубине холодильника. И задача, решаемая с его помощью, заключается в проверке того, сможет ли холодильник пройти через кухонную дверь (см. рис. 3.10). 
Пусть картон совсем не похож на холодильник, но он оказался весьма полезен, когда нам нужно было решить, покупать ли эту модель или выбрать модель меньшего размера. Опять же, все модели не точны, но некоторые из них полезны. Создание 3D-модели холодильника, безусловно, будет интересной задумкой. Но решит ли это проблему более эффективно, чем картон? Нет. Если подходит картон, подойдет и 3D-модель, и наоборот. 
С точки зрения разработки программных продуктов, создание 3D-модели холодильника было бы неоправданным переусложнением. 
А как насчет высоты холодильника? Что делать, если основание подходит, но холодильник может оказаться выше дверного проема? Оправдывает ли это склеивание 3D-модели холодильника? Нет. Проблему можно решить гораздо быстрее и проще, если измерить высоту дверного проема простой рулеткой. Что такое рулетка в данном случае? Это еще одна простая модель.

![[Рис. 3.10. Картонная модель в дверном проеме кухни.png]]

Итак, в итоге получились две модели одного и того же холодильника. Использование двух моделей, каждая из которых оптимизирована для решения своей конкретной задачи, отражает подход DDD к моделированию предметных областей. Каждая модель имеет свой строго ограниченный контекст: картон, подтверждающий, что основание холодильника может пройти через вход в кухню, и рулетка, подтверждающая, что этот холодильник не слишком высокий. Модель должна исключать лишнюю информацию, не имеющую отношения к поставленной задаче. Кроме того, нет необходимости разрабатывать сложную универсальную модель, если несколько гораздо более простых моделей способны помочь эффективному решению каждой задачи по отдельности. 
Через несколько дней после публикации этой истории в «Твиттере», я получил ответ, в котором говорилось, что вместо возни с картоном, я мог бы просто воспользоваться мобильным телефоном со сканером LiDAR и приложением дополненной реальности (AR). Давайте проанализируем это предложение с точки зрения предметно-ориентированного проектирования. 
Автор комментария утверждает, что эта задача уже решена другими людьми, и это решение находится в открытом доступе. Излишне говорить, что и технология сканирования, и приложение дополненной реальности весьма непросты. На жаргоне DDD это относит проблему проверки возможности прохода холодильника в дверной проем к универсальному поддомену.

# Вывод 
При каждом столкновении с неизбежным конфликтом ментальных моделей экспертов предметной области нам приходится разбивать единый язык на несколько ограниченных контекстов. Единый язык в рамках своего ограниченного контекста должен быть непротиворечивым. 
Но в ограниченных контекстах одни и те же понятия могут иметь разные значения. При выявлении поддоменов разрабатываются ограниченные контексты. Разбиение предметной области на ограниченные контексты является стратегическим проектным решением. 
Ограниченный контекст и его единый язык могут реализовываться и поддерживаться одной командой. Никакие две команды не должны совместно работать над одним и тем же ограниченным контекстом. Но одна и та же команда может работать с несколькими ограниченными контекстами. 
Ограниченные контексты разбивают систему на физические компоненты — сервисы, подсистемы и т. д. Жизненный цикл каждого ограниченного контекста отделен от всех остальных. Каждый ограниченный контекст может развиваться независимо от остальной системы. Но, чтобы сформировать систему, ограниченные контексты должны работать вместе. Некоторые изменения непреднамеренно будут оказывать влияние и на другой ограниченный контекст. В следующей главе будут рассмотрены различные паттерны интеграции ограниченных контекстов, которыми можно будет воспользоваться для их защиты от каскадных изменений.
