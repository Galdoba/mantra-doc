---
updated_at: 2025-12-12T16:11:24.710+10:00
tags:
  - part3
  - chapter13
---
# Предметно-ориентированное проектирование на практике

Итак, нами рассмотрены инструменты предметно-ориентированного проектирования, предназначенные для анализа предметных областей (`business domains`), обмена знаниями и принятия стратегических и тактических проектных решений. А теперь представьте, как все эти знания будут применяться на практике. Давайте рассмотрим сценарий работы над новым проектом. Все ваши коллеги неплохо разбираются в предметно-ориентированном проектировании и с самого начала делают все возможное для разработки эффективных моделей, и, конечно же, непременно используют единый язык (`ubiquitous language`). В ходе разработки проекта уточняются границы ограниченных контекстов (`bounded contexts`), повышается эффективность защиты моделей предметной области. И наконец, поскольку все тактические проектные решения согласуются с бизнес-стратегией, кодовая база всегда находится в отличной форме: все говорят на едином языке и пользуются паттернами (`patterns`) проектирования, соответствующими сложности модели. Но теперь давайте вернемся в реальность.

Ваши шансы попасть в только что расписанные лабораторные условия ничуть не выше, чем выиграть в лотерею. Конечно же, все возможно, но крайне маловероятно. К сожалению, многие люди ошибочно полагают, что предметно-ориентированное проектирование применимо только к проектам, запускаемым с нуля и в идеальных условиях, в командах, где у каждого имеется свидетельство о высшей квалификации в этой сфере. По иронии судьбы наибольшая выгода от предметно-ориентированного проектирования извлекается для проектов, уже запущенных в производство, уже доказавших свою бизнес-состоятельность и нуждающихся во встряске, позволяющей справиться с накопленным техническим долгом и проектной дисгармонией. Так совпало, что работа над такими заброшенными, унаследованными кодовыми базами, превращенными в большие комки грязи, и является тем, на что тратится большая часть нашей карьеры в области разработки программного обеспечения.

Еще одно распространенное заблуждение о предметно-ориентированном проектировании заключается в том, что в нем работает принцип «все или ничего»: либо вы применяете все инструменты, предлагаемые методологией, либо это не предметно-ориентированное проектирование. Но это не так. Разобраться со всеми присущими ему концепциями, не говоря уже о том, чтобы реализовать их на практике, может показаться непосильной задачей. К счастью, чтобы извлечь выгоду из предметно-ориентированного проектирования не нужно применять все паттерны и методы. Особенно это актуально для уже состоявшихся проектов, где внедрить все эти паттерны и практики в разумные сроки практически невозможно.

В этой главе состоится знакомство со стратегиями применения инструментов и паттернов предметно-ориентированного проектирования в мире реальных разработок, в том числе в уже запущенных проектах и в далеко не идеальных средах.

## Стратегический анализ

Следуя порядку нашего изучения паттернов и методов предметно-ориентированного проектирования, лучшей отправной точкой для его внедрения в организации является выделение времени на осмысление бизнес-стратегии организации и текущего состояния архитектуры ее систем.

### Осмысление предметной области

Во-первых, нужно определить сферу деятельности компании:

*   Какова предметная область (`business domain`) деятельности организации?
*   Кто ее клиенты?
*   Какую услугу или ценность организация предоставляет клиентам?
*   С какими компаниями или продуктами конкурирует организация?

Ответив на эти вопросы, можно получить взгляд на высокоуровневые цели компании с высоты птичьего полета. Затем следует «приблизить взгляд» к предметной области и найти поддомены (`subdomains`), т. е. структурные элементы бизнеса, используемые организацией для достижения своих высокоуровневых целей.

Хорошей исходной эвристикой является организационная структура компании: ее отделы и другие организационные единицы. Изучите порядок сотрудничества этих подразделений, позволяющий компании успешно конкурировать в своей бизнес-сфере.

Кроме того, следует поискать признаки конкретных типов поддоменов.

#### Основные поддомены (`core subdomains`)

Чтобы определить основные поддомены компании, найдите то, чем она отличается от своих конкурентов:

*   Есть ли у компании «уникальная особенность», отсутствующая у конкурентов? Например, такая интеллектуальная собственность, как патенты и алгоритмы, разработанные собственными силами?
*   Учтите, что конкурентное преимущество, а следовательно, и основные поддомены не обязательно имеют техническую природу. Обладает ли компания каким-либо нетехническим конкурентным преимуществом? Например, умением нанять высококвалифицированный персонал, создать уникальный художественный дизайн и т. д.?

Еще одна весьма действенная, но столь же печальная эвристика для основных поддоменов — выявление программных компонентов с наихудшим дизайном — тех самых больших комков грязи, ненавидимых всеми программистами, которые бизнес не захотел переписывать с нуля из-за сопутствующих бизнес-рисков. Ключевым моментом здесь является невозможность замены устаревшей системы на уже готовую, иначе такой поддомен являлся бы универсальным (`generic subdomain`), и то, что любая ее модификация повлечет за собой бизнес-риски.

#### Универсальные поддомены

Чтобы определить универсальные поддомены, нужно поискать готовые решения, услуги по подписке или интегрировать в систему программное обеспечение с открытым исходным кодом. Из главы 1 известно, что одни и те же готовые решения должны быть доступны конкурирующим компаниям, и компании, использующие эти же решения, не должны иметь никакого влияния на бизнес вашей компании.

#### Вспомогательные поддомены (`supporting subdomains`)

Для поиска вспомогательных поддоменов нужно посмотреть на оставшиеся программные компоненты, которые нельзя заменить готовыми решениями, но которые напрямую не дают никаких конкурентных преимуществ. Если программный код несовершенен, работа с ним вызывает меньшее недовольство со стороны разработчиков программного обеспечения, когда такой код приходится изменять довольно редко. Таким образом, последствия неоптимального дизайна программного кода не столь серьезны, как в случае основных поддоменов.

Идентифицировать все основные поддомены совсем необязательно. Это будет нецелесообразно или даже невозможно сделать даже для компании среднего размера. Лучше будет определить общую структуру, но при этом уделить больше внимания поддоменам, представляющим наибольшую важность для программных систем, над которыми ведется работа.

### Изучение текущего проекта

Как только пройдет ознакомление с пространством задач (`problem space`), появится возможность продолжить исследование реализации и принятых в её рамках проектных решений. Начать следует с компонентов высокого уровня. Ими не обязательно должны быть ограниченные контексты (`bounded contexts`) в смысле предметно-ориентированного проектирования, это скорее границы, используемые для разбиения бизнес-области на подсистемы.

Характерным свойством, на которое следует обратить внимание, являются разобщенные жизненные циклы компонентов. Даже если подсистемы расположены в одном и том же репозитории системы контроля версиями (монорепозитории) или если все компоненты находятся в одной монолитной кодовой базе, проверьте, какие из них могут быть разработаны, протестированы и развернуты независимо от всех остальных.

### Оценка тактического замысла

Для каждого высокоуровневого компонента следует проверить, какие бизнес-поддомены он содержит и какие технические решения были приняты, т. е. ответить на вопрос: какие паттерны используются для реализации бизнес-логики и описания архитектуры компонента?

Соответствует ли выбранное решение сложности изначальной задачи? Есть ли области, где необходимы более сложные паттерны проектирования? И наоборот, имеются ли поддомены, где можно срезать углы или воспользоваться существующими готовыми решениями? Воспользуйтесь этой информацией для принятия более взвешенных стратегических и тактических решений.

### Оценка стратегического замысла

Воспользуйтесь знаниями о высокоуровневых компонентах для составления схемы карты контекстов (`context map`) текущего проекта, представив себе эти высокоуровневые компоненты в виде ограниченных контекстов. Выявите и отследите отношения между компонентами с позиции паттернов интеграции ограниченных контекстов.

И наконец, проанализируйте полученную карту контекстов и оцените архитектуру с точки зрения предметно-ориентированного проектирования. Имеются ли неоптимальные стратегические проектные решения? Например:

*   Над одним и тем же высокоуровневым компонентом работает сразу несколько команд.
*   Продублированы реализации основных поддоменов.
*   Основной поддомен реализован сторонней компанией.
*   Частые сбои в интеграции выливаются в конфликты.
*   Внешними сервисами и унаследованными системами навязываются неудобные модели.

Эти сведения являются полезной отправной точкой для планирования стратегии модернизации проекта. Но сначала, учитывая полученные более глубокие знания как о пространстве задач (предметной области), так и о пространстве решений (`solution space`), следует выявить пробелы в знании предметной области. Из главы 11 известно, что знания о бизнес-области могут быть утрачены по разным причинам. Эта проблема весьма распространена и актуальна в основных поддоменах, где бизнес-логика не только сложна, но и критична для бизнеса. Столкнувшись с этим обстоятельством, следует предпринять попытку восстановления утраченных знаний путем проведения `EventStorming`. Кроме того, системой `EventStorming` нужно воспользоваться в качестве основы для развития единого языка.

## Определение стратегии модернизации

Попытки «большого переписывания», когда программисты пытаются переписать систему с нуля, организовав на этот раз приемлемое проектирование и реализацию всей системы, редко приводят к успеху. Еще реже такие архитектурные обновления поддерживаются руководством.

При более бережном подходе к улучшению дизайна существующих систем масштабный замысел сочетается с малыми начинаниями. Как говорит Эрик Эванс (`Eric Evans`), качественное проектирование распространяется далеко не на всю большую систему. Это непреложный факт, и поэтому нужно принять стратегическое решение, куда именно следует приложить усилия по модернизации. Обязательным условием для принятия такого решения является наличие границ, разделяющих поддомены системы. Границы не обязательно должны быть физическими, превращающими каждый поддомен в полноценный ограниченный контекст. Лучше, как показано на рис. 13.1, начать как минимум с того, чтобы выровнять логические границы (ограничивающие пространства имен, модули и пакеты, в зависимости от технологического стека) с границами поддоменов. 

![[Рис. 13.1. Реорганизация модулей ограниченного контекста.png]]

Перестановка модулей системы — относительно безопасная форма рефакторинга. Бизнес-логика остается прежней, а типы просто перемещаются в более удачную структуру. И тем не менее следует убедиться, что ссылки по полным именам типов, например для динамической загрузки библиотек, для рефлексии (`reflection`) и т. д., не нарушаются.

Кроме того, нужно отслеживать бизнес-логику поддоменов, реализованную в других кодовых базах: хранимые процедуры базы данных, бессерверные (`serverless`) функции и т. д. Нужно не забыть провести новые границы и на этих платформах. Например, если часть логики обрабатывается в хранимых процедурах базы данных, нужно либо переименовать процедуры, чтобы в именах фигурировал модуль, к которому они принадлежат, либо применить выделенную схему базы данных и переместить хранимые процедуры.

## Стратегическая модернизация

Из главы 10 известно, что преждевременное разбиение системы на наименьшие из возможных ограниченных контекстов может быть сопряжено с риском. Более подробно ограниченные контексты и микросервисы будут рассмотрены в следующей главе. А пока поищите, где можно извлечь наибольшую пользу от превращения логических границ в физические. Процесс извлечения ограниченного контекста (или контекстов) путем превращения логической границы в физическую показан на рис. 13.2. 

Нужно задаться следующими вопросами:

- Сколько команд работает над одной и той же кодовой базой? Если несколько, следует развязать жизненные циклы разработки, определив свои ограниченные контексты для каждой команды.
- Пользуются ли разные компоненты конфликтующими моделями? Если да, то конфликтующие модели следует переместить в отдельные ограниченные контексты.

![[Рис. 13.2. Извлечение ограниченного контекста путем превращения логической границы в физическую.png]]

Когда работа по созданию минимально необходимых ограниченных контекстов будет завершена, следует изучить отношения и паттерны интеграции между ними. Нужно присмотреться к порядку общения и сотрудничества команд, работающих над разными ограниченными контекстами. Имеются ли у команд общие цели и адекватные уровни сотрудничества, особенно когда они используют общение через ситуативную (`ad hoc`) интеграцию контекстов или интеграцию контекстов с общим ядром (`shared kernel`)?

Обратите внимание на те проблемы, которые могут быть решены за счет применения паттернов интеграции контекстов:

*   **Отношения потребитель-поставщик (`customer-supplier`)**  
    Из главы 11 известно, что разрастание организации может свести на нет прежние модели общения и сотрудничества. Нужно найти компоненты, спроектированные с учетом партнерских отношений нескольких команд разработчиков, но уже утратившие былую устойчивость, и при необходимости провести их рефакторинг под отношения соответствующего типа из разряда потребитель-поставщик (применив паттерны «Конформист», «Предохранительный слой» (`anticorruption layer`) или сервис с открытым протоколом [`open-host service`]).
*   **Предохранительный слой (`anticorruption layer`)**  
    Предохранительные слои могут оказаться полезными для защиты ограниченных контекстов от устаревших систем, особенно если в последних используются неэффективные модели с тенденцией распространения на нижестоящие компоненты. Еще один распространенный случай применения слоя защиты от изменений связан с ограждением ограниченного контекста от частых изменений в используемых им открытых интерфейсах вышестоящего сервиса.
*   **Сервис с открытым протоколом (`open-host service`)**  
    Если изменения в деталях реализации одного компонента часто распространяются по системе и влияют на ее потребителей, стоит призадуматься над тем, чтобы сделать его сервисом с открытым протоколом: отделить его модель реализации от предоставляемого им открытого `API`.
*   **Разные пути (`separate ways`)**  
    В крупных организациях весьма высока вероятность конфликтов, возникающих между командами разработчиков из-за необходимости сотрудничать и совместно совершенствовать общие функции. Если функциональные возможности, являющиеся «яблоком раздора», для бизнеса не критичны, т. е. не входят в основной поддомен, команды могут пойти разными путями и реализовать свои собственные решения, устраняя тем самым источник разногласий.

## Тактическая модернизация

С тактической точки зрения в первую очередь нужно найти самые «наболевшие» несоответствия в ценностях для бизнеса и стратегиях реализаций, когда, к примеру, паттерны реализации основных поддоменов (транзакционный сценарий (`transaction script`) или же активная запись (`active record`)) не соответствуют сложности модели. Такие системные компоненты, напрямую влияющие на успех бизнеса, должны изменяться чаще всего, но их сложно сопровождать и совершенствовать из-за неудобного дизайна.

### Развитие единого языка

Необходимым условием успешной модернизации проекта является знание предметной области и эффективная модель предметной области. Как уже неоднократно упоминалось в этой книге, для получения знаний и построения эффективной модели решения необходим единый язык (`ubiquitous language`) предметно-ориентированного проектирования.

Не стоит забывать, что в предметно-ориентированном проектировании есть быстрый способ сбора знаний о предметной области: `EventStorming`. Используйте `EventStorming` для выработки единого с экспертами предметной области языка и изучения устаревшей кодовой базы, особенно если она представляет собой не имеющий подробной документации беспорядочный код, который никто по-настоящему не понимает. Соберите всех, кто связан с работой этой кодовой базы, и исследуйте предметную область. `EventStorming` — великолепный инструмент восстановления знаний о предметной области.

Вооружившись знаниями о предметной области и ее моделями, следует решить, какие паттерны реализации бизнес-логики больше всего подходят для рассматриваемой бизнес-функциональности. В качестве отправной точки нужно воспользоваться эвристикой проектирования, рассмотренной в главе 10. Следующее решение, которое следует принять, касается стратегии модернизации: постепенной замены целых компонентов системы (паттерн «Душитель», `Strangler`) или постепенного рефакторинга существующего решения.

### Паттерн «Душитель» (`Strangler`)

Инжир-душитель, показанный на рис. 13.3, относится к семейству тропических деревьев, имеющих специфический способ развития: душители растут поверх других деревьев-хозяев. Жизнь душителя начинается с семени на верхних ветвях дерева-хозяина. По мере роста душитель спускается вниз, пока не укоренится в почве. В конечном итоге у душителя вырастает листва, затеняющая дерево-хозяина, что приводит к гибели последнего. 

![[Рис. 13.3. Инжир-душитель.png]]

Паттерн миграции «Душитель» (`strangler`) основан на той же динамике развития, что и растение, в честь которого он назван. Идея заключается в создании нового ограниченного контекста — душителя — и его применении для реализации новых требований и постепенной миграции в его функциональность устаревшего контекста. Одновременно с этим, за исключением исправлений и других чрезвычайных ситуаций, останавливается доработка и развитие устаревшего ограниченного контекста. В конечном итоге вся функциональность переносится в новый ограниченный контекст — душитель — и по аналогии, приводящей к смерти дерева-хозяина, к избавлению от устаревшей кодовой базы.

Обычно паттерн «Душитель» используется в тандеме с паттерном «Фасад» (`facade`): тонким уровнем абстракции, действующим в качестве публичного интерфейса и отвечающим за перенаправление запросов на обработку либо в устаревший, либо в модернизированный ограниченный контекст. Когда миграция завершается, т. е. когда «хозяин» умирает, фасад удаляется, т. к. он уже больше не нужен (рис. 13.4). 

![[Рис. 13.4. Слой фасада перенаправляет запрос в зависимости от состояния переноса функциональности из устаревшей системы.png]]

При реализации паттерна «Душитель» можно частично отойти от принципа, согласно которому каждый ограниченный контекст является отдельной подсистемой и, следовательно, не может совместно использовать свою базу данных с другими ограниченными контекстами. И новый, и устаревший контекст может пользоваться одной и той же базой данных, чтобы избежать сложной интеграции между контекстами, которая во многих случаях может повлечь за собой распределенные транзакции — как показано на рис. 13.5, оба контекста должны работать с одними и теми же данными. Рис. 13.5. И старая, и новая система временно работает с одной и той же базой данных

Условием изменения правила об отдельной базе данных для каждого ограниченного контекста является то, что в конечном итоге, и чем раньше, тем лучше, устаревший контекст будет удален, а база данных будет использоваться исключительно новой реализацией.

Альтернативой миграции на основе паттерна «Душитель» является модернизация существующей кодовой базы, также называемая рефакторингом.

![[Рис. 13.5. И старая, и новая система временно работает с одной и той же базой данных.png]]

## Рефакторинг тактических проектных решений

Различные аспекты миграции тактических проектных решений уже рассматривались в главе 11. Но есть два нюанса, о которых не следует забывать при модернизации устаревшей кодовой базы.

Во-первых, вместо масштабной переработки намного безопаснее будет проводить миграцию небольшими последовательными этапами. Поэтому не стоит перерабатывать транзакционный сценарий или активную запись сразу же в модель предметной области, основанную на событиях. Вместо этого лучше провести промежуточный этап проектирования агрегатов, основанных на состоянии. Приложите усилия к поиску эффективных границ агрегатов. Убедитесь, что в эти границы попадает вся связанная бизнес-логика. Переход от агрегатов, основанных на состоянии (`state-based`), к агрегатам, основанным на событиях (`event sourced aggregates`), будет на порядок безопаснее, чем выявление некорректных границ транзакций в агрегатах, основанных на событиях.

Во-вторых, следуя той же логике небольших последовательных этапов, рефакторинг модели предметной области не обязан быть атомарным изменением. Элементы паттерна модели предметной области могут вводиться постепенно.

Начните с поиска возможных объектов-значений. Неизменяемые объекты могут существенно упростить решения, даже если пока еще не используется полноценная модель предметной области.

В главе 11 было выяснено, что рефакторинг активных записей в агрегаты не обязательно проводить «за одну ночь». Это можно сделать поэтапно. Начать следует со сбора соответствующей бизнес-логики. Затем нужно проанализировать границы транзакций. Узнать, есть ли решения, требующие строгой согласованности, но оперирующие данными в режиме согласованности в конечном счете (`eventual consistency`)? Или же наоборот, применяется ли решение со строгой согласованность там, где будет достаточно согласованности в конечном счете? При анализе кодовой базы не следует забывать, что эти решения обусловлены не технологией, а бизнес-задачами. Проектировать границы агрегата можно будет только после тщательного анализа требований к транзакциям.

И наконец, при необходимости в процессе рефакторинга устаревшей системы новую кодовую базу следует защитить от старых моделей с помощью предохранительного слоя (`anticorruption layer`), а потребителей следует защитить от изменений в устаревшей кодовой базе за счет внедрения сервиса с открытым протоколом (`open-host service`) и предоставления опубликованного языка (`published language`).

## Прагматичное предметно-ориентированное проектирование

Во введении в эту главу уже говорилось, что применение предметно-ориентированного проектирования не является чем-то из разряда «все или ничего». Применять буквально каждый инструмент, предлагаемый `DDD`-технологией, не нужно. Может оказаться так, что по какой-то причине тактические паттерны могут у вас не работать. Возможно, ваше предпочтение отдается другим паттернам проектирования, поскольку в вашей конкретной области они работают лучше, или же просто потому, что эти паттерны считаются более эффективными. Это абсолютно нормально!

В ходе анализа своей предметной области и ее стратегии нужно подбирать эффективные модели для решения конкретных задач и, что наиболее важно, принимать проектные решения на основе потребностей предметной области: в этом и есть смысл предметно-ориентированного проектирования!

Стоит еще раз подчеркнуть, что предметно-ориентированное проектирование не связано с агрегатами (`aggregate`) или объектами-значениями (`value object`). Его смысл заключается в том, чтобы позволить предметной области вашего бизнеса управлять решениями по проектированию программного обеспечения.

## Как «продать» предметно-ориентированное проектирование?

Когда я выступаю на рассматриваемую нами тему на технологических конференциях, практически всегда получаю один и тот же вопрос: «Звучит здорово, но как мне “продать” предметно-ориентированное проектирование своей команде и руководству?» Это чрезвычайно важный вопрос.

Продавать нелегко, и лично я ненавижу этот процесс. Тем не менее, если подумать, разработка программного обеспечения продается. Мы продаем наши идеи команде, руководству или клиентам. Но продать методологию, охватывающую столь широкий спектр аспектов проектных решений и даже выходящую за пределы зоны проектирования с целью привлечения других заинтересованных лиц, может быть чрезвычайно трудно.

Без поддержки руководства не обойдется ни одно существенное организационное изменение. Но если руководители высшего звена пока еще не знакомы с предметно-ориентированным проектированием или не готовы уделить свое время изучению бизнес-ценности этой методологии, то она не будет для них приоритетом, тем более что сдвиг в процессе проектирования, связанный с применением `DDD`, представляется им весьма значительным. Но, к счастью, это совершенно не означает отсутствие возможности использования вами предметно-ориентированного проектирования.

### Законспирированное предметно-ориентированное проектирование

Превратите предметно-ориентированное проектирование не в организационную стратегию, а в часть своего профессионального набора инструментов. Паттерны и методы, присущие `DDD`, относятся к технологии программирования, и, поскольку вашей работой является разработка программного обеспечения, воспользуйтесь ими!

Давайте посмотрим, как можно будет внедрить `DDD` в свою повседневную работу, не создавая при этом слишком много шума.

#### Единый язык

Использование единого языка (`ubiquitous language`) является краеугольным камнем практики предметно-ориентированного проектирования. Он необходим для выявления знаний предметной области, общения и эффективного моделирования решений.

К счастью, эта совершенно обычная практика, не выходящая за рамки здравого смысла. Прислушивайтесь к языку, которым пользуются заинтересованные стороны при обсуждении предметной области. Аккуратно направляйте терминологию из технического жаргона в сторону ее бизнес-значения.

Выискивайте противоречивые термины и требуйте их разъяснения. Например, если у одного и того же предмета несколько названий, ищите причину этого. Не встречаются ли столь разные модели в одном и том же решении? Возможно, что это скрытый контекст, который нужно сделать явным. Если значение одно и то же, проявите здравомыслие и потребуйте использования одного и того же термина.

Кроме того, общайтесь как можно больше с экспертами предметной области. И для этого вовсе не нужны сугубо формальные встречи. Лучше общаться где-нибудь в непринужденной обстановке за чашечкой кофе. Поговорите с бизнес-экспертами о сфере бизнеса. Попробуйте перейти на их язык. Выискивайте сложности в понимании и просите разъяснений. И не стоит переживать — бизнес-эксперты обычно рады сотрудничеству с разработчиками, искренне заинтересованными в изучении предметной области!

Самое главное, используйте единый язык в своем коде и во всем информационном обмене, связанном с проектом. Проявите терпение. Изменение терминологии, ранее устоявшейся в вашей организации, потребует некоторого времени, но в конечном итоге она все равно приживется.

#### Ограниченные контексты

Изучая возможные варианты декомпозиции, определите принципы, лежащие в основе паттерна ограниченного контекста:

*   Почему лучше разрабатывать проблемно-ориентированные модели, а не одну модель для всех сценариев использования? Потому что решения «все в одном» редко бывают эффективны абсолютно для всего.
*   Почему ограниченный контекст не может содержать конфликтующие модели? Из-за возрастающей сложности решения и трудностей в его понимании.
*   Почему работа нескольких команд над одной и той же кодовой базой — плохая затея? Из-за постоянно возникающих конфликтов между командами, препятствующих сотрудничеству.

Воспользуйтесь той же самой аргументацией и для паттернов интеграции ограниченных контекстов: убедитесь, что задача, решаемая каждым паттерном, вам ясна и понятна.

#### Тактические проектные решения

Обсуждая паттерны тактического проектирования, не апеллируйте к авторитету: «Давайте воспользуемся здесь агрегатом, поскольку так написано в книге по предметно-ориентированному проектированию!» Лучше включите логику. Например:

*   Почему так важны четкие границы транзакций? Для защиты согласованности данных.
*   Почему транзакция базы данных не может изменить более одного экземпляра агрегата? Чтобы обеспечить корректность границ согласованности.
*   Почему внешний компонент не может напрямую изменить состояние агрегата? Чтобы обеспечить совместное размещение всей связанной бизнес-логики и отсутствие ее дубликатов.
*   Почему нельзя передавать часть функций агрегата хранимой процедуре? Чтобы обеспечить отсутствие продублированности какой-либо логики. Продублированная логика, особенно в логически и физически удаленных компонентах системы, склонна к рассинхронизации и повреждению данных.
*   Почему нужно стремиться к тому, чтобы границы агрегатов имели наименьший размер? Потому что большой объем изменений в рамках одной транзакции усложняет агрегат и отрицательно влияет на производительность.
*   Почему вместо событий как источника данных нельзя просто записывать события в файл журнала? Потому что это не дает долгосрочных гарантий согласованности данных.

Если же говорить о событиях как источниках данных (`event sourcing`), то, когда решение потребует воспользоваться моделью предметной области, основанной на событиях (`event-sourced domain model`), продвижение реализации паттерна этой модели может столкнуться с трудностями. Давайте взглянем на психологический прием опытного специалиста, способный помочь в этом деле.

#### Модель предметной области, основанная на событиях

Несмотря на множество преимуществ, словосочетание «события как источник данных» (`event sourcing`) звучит для многих слишком радикально. Как и в отношении всего, что рассматривалось в этой книге, решение заключается в том, чтобы позволить предметной области управлять самим этим решением.

Поговорите с экспертами предметной области. Покажите им модели, основанные на состояниях и событиях. Объясните, чем они отличаются друг от друга и раскройте преимущества, предлагаемые использованием событий как источника данных, особенно в отношении временного измерения (фактора времени). Скорее всего, они придут в восторг от предоставляемого этой технологией уровня проникновения в суть процесса и сами станут выступать за использование паттерна события как источника данных (`event sourcing`).

Общаясь с экспертами предметной области, не забывайте работать над совершенствованием единого языка!

# Вывод

В этой главе были рассмотрены различные методы использования инструментальных средств предметно-ориентированного проектирования в реальных сценариях: при работе над уже существующими проектами и с устаревшими кодовыми базами, причем не обязательно с уже готовой командой зрелых специалистов в области предметно-ориентированного проектирования.

Как и в проектах, запускаемых с нуля, всегда начинайте с анализа предметной области. Задайтесь следующим вопросом: каковы цели компании и стратегия их достижения? Воспользуйтесь организационной структурой и уже существующими решениями по проектированию программного обеспечения, чтобы определить поддомены, приемлемые для организации и их типы. Обладая этими знаниями, спланируйте стратегию модернизации. Ищите узкие места. Стремитесь извлечь наибольшую ценность для бизнеса. Модернизируйте устаревший код либо путем рефакторинга, либо путем замены тех или иных компонентов. В любом случае делайте это постепенно. Большие переделки влекут за собой более высокую степень риска, а не повышение их ценности для бизнеса!

И последнее: инструменты предметно-ориентированного проектирования можно использовать даже в том случае, если методология `DDD` еще не получила широкого распространения в вашей организации. Воспользуйтесь приемлемыми инструментами, а при их обсуждении с коллегами всегда используйте логику и принципы, положенные в основу каждого паттерна.

Эта глава завершает рассмотрение самого предметно-ориентированного проектирования как такового. В четвертой части книги речь пойдет о взаимодействии предметно-ориентированного проектирования с другими методологиями и паттернами.