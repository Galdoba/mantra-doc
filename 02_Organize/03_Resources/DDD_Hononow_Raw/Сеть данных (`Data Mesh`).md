---
updated_at: 2025-12-12T17:35:32.678+10:00
tags:
  - part4
  - chapter16
---
До сих пор в этой книге рассматривались модели, используемые для построения транзакционных систем. В этих системах реализуются транзакции в режиме реального времени, манипулирующие данными системы и организующие ее повседневное взаимодействие с окружающей средой. Рассмотренные модели представляют собой данные обработки транзакций (`online transactional processing, OLTP`). Еще один тип данных, заслуживающий внимания и надлежащего моделирования, — данные аналитической обработки (`online analytical processing, OLAP`).

В этой главе будет рассмотрена архитектура управления аналитическими данными, которая называется сетью данных (`data mesh`). Будет показано, как работает архитектура, основанная на сети данных (`data mesh`), и чем она отличается от более традиционных подходов к управлению `OLAP`-данными. И наконец, будет показано, как предметно-ориентированное проектирование и сеть данных (`data mesh`) сочетаются друг с другом. Но сначала давайте посмотрим, что собой представляют эти аналитические модели данных и почему для обработки аналитических данных нельзя просто повторно воспользоваться транзакционными моделями.

## Сравнение аналитической модели данных (`OLAP`) с моделью транзакционных данных (`OLTP`)

Говорят, что знание — сила. Аналитические данные — это знания, которые дают компаниям возможность использовать накопленные сведения для получения информации о том, как оптимизировать бизнес, лучше разобраться в потребностях клиентов и даже принимать решения в автоматическом режиме путем формирования моделей машинного обучения (`machine learning, ML`).

Аналитические модели (`OLAP`) и транзакционные модели (`OLTP`) обслуживают разные типы потребителей, позволяют реализовывать разные сценарии использования и поэтому проектируются по-разному.

Транзакционные модели строятся вокруг различных сущностей из предметной области системы, реализуя их жизненные циклы и организуя их взаимодействие друг с другом. Эти модели, изображенные на рис. 16.1, обслуживают транзакционные системы и, следовательно, должны быть оптимизированы для поддержки бизнес-транзакций в режиме реального времени. 

![[Рис. 16.1. Схема реляционной базы данных, описывающая отношения между сущностями в транзакционной модели.png]]

Аналитические модели разработаны для поиска обеспечения различных озарений о транзакционных системах. Аналитическая модель используется не для осуществления транзакций в режиме реального времени, а для получения представления о бизнес-метриках и, что более важно, о том, как бизнес может оптимизировать свои операции для извлечения большей выгоды.

С позиции структуры данных в `OLAP`-моделях отдельно взятые бизнес-объекты просто игнорируются, а все внимание сосредоточивается на бизнес-операциях с моделированием таблиц фактов и таблиц измерений. А теперь давайте присмотримся к каждой из этих таблиц.


### Таблица фактов

Факты представляют собой уже произошедшую деловую активность. Факты аналогичны понятию событий предметной области в том смысле, что в обоих случаях дается описание того, что уже произошло. Но, в отличие от событий предметной области, в фактах отсутствует стилистическое требование называть их глаголами в прошедшем времени. Как бы то ни было, факты представляют собой действия в рамках бизнес-процессов. Например, таблица фактов `Fact_CustomerOnboardings` будет содержать запись для каждого нового подключенного клиента, а `Fact_Sales` — запись для каждой совершенной продажи. Пример таблицы фактов показан на рис. 16.2. 

![[Рис. 16.2. Таблица фактов, содержащая записи об обращениях, рассмотренных службой поддержки компании.png]]

Кроме того, как и события предметной области, записи фактов никогда не удаляются и не изменяются: аналитические данные предназначены только для добавления — единственный способ отметить, что данные уже устарели, заключается в добавлении новой записи с текущим состоянием. Рассмотрим таблицу фактов `Fact_CaseStatus`, показанную на рис. 16.3. В ней содержатся наблюдения за состояниями запросов на поддержку в течение некоторого времени. В названии факта нет явного глагола, но бизнес-процесс, отраженный фактом, не что иное, как процесс обработки обращений в службу поддержки. 

![[Рис. 16.3. Таблица фактов с описанием изменения состояния в течение жизненного цикла обращений в службу поддержки.png]]

Еще одно существенное различие между моделями `OLAP` и `OLTP` заключается в степени детализации данных. Транзакционные системы требуют для обработки бизнес-транзакций самых точных данных. Для аналитических моделей во многих случаях использования более эффективны сводные данные. Например, в таблице `Fact_CaseStatus`, показанной на рис. 16.3, видно, что снимки создаются каждые 30 минут. Решение о приемлемом уровне детализации принимают аналитики данных, работающие с моделью. Создание записи факта для каждого изменения показателя, например для каждого изменения данных при том или ином развитии событий, в одних случаях было бы слишком расточительным, а в других — и вовсе технически невозможным.

### Таблица измерений

Еще одним важным структурным элементом аналитической модели является измерение (`dimension`). Если факт представляет собой бизнес-процесс или действие (выражаемое глаголом), то измерение дает описание факта (со свойствами прилагательного).

Измерения предназначены для описания атрибутов фактов, и на них ссылаются как на внешний ключ из таблицы фактов в таблицу измерений. Атрибуты, смоделированные как измерения, представляют собой любые измерения или данные, повторяющиеся в разных записях фактов и не способные уместиться в одном столбце. Например, схема на рис. 16.4 дополняет факт `SolvedCases` его измерениями. 

![[Рис. 16.4. Факт `SolvedCases` в окружении его измерений.png]]

Причиной высокой стандартизации измерений является потребность аналитической системы в поддержке гибких (`flexible`) запросов. Это еще одно различие между транзакционным и аналитическими моделями. Запросы, предъявляемые к операционным моделям для поддержки бизнес-требований, предсказуемы. А вот паттерны запросов к аналитическим моделям непредсказуемы. Аналитикам данных нужны гибкие способы просмотра данных, и какие именно запросы будут выполняться в будущем, предсказать довольно трудно. В результате стандартизация поддерживает динамические запросы и фильтрацию, а также группировку данных фактов по разным измерениям.

### Аналитические модели

Структура таблицы, изображенная на рис. 16.5, называется схемой «звезда». Она основана на отношениях «многие к одному», установленных между фактами и их измерениями: каждая запись измерения используется многими фактами, а внешний ключ факта указывает на запись одного из измерений. 

![[Рис. 16.5. Отношения «многие к одному» между фактами и их измерениями.png]]

Другой доминирующей аналитической моделью является схема снежинки. Она основана на тех же строительных блоках: фактах и измерениями. Но, как показано на рис. 16.6, в схеме «снежинка» измерения являются многоуровневыми: каждое измерение дополнительно нормализуется в более мелкие измерения. 

![[Рис. 16.6. Многоуровневые измерения в схеме «снежинка».png]]

В результате дополнительной нормализации схема «снежинка» будет занимать меньше места для хранения данных измерения и ее будет легче поддерживать. Но запрос данных, составляющих факты, потребует объединения большего количества таблиц, и, следовательно, понадобится больший объем вычислительных ресурсов.

Обе схемы, и «звезда», и «снежинка», позволяют аналитикам данных проанализировать эффективность бизнеса, получая представление о том, что можно оптимизировать и встроить в отчеты бизнес-аналитики (`business intelligence, BI`).

## Платформы управления аналитическими данными

Давайте перенесем обсуждение с аналитического моделирования на архитектуры управления данными, поддерживающие создание и обслуживание аналитических данных. В этом разделе будут рассмотрены две наиболее распространенные архитектуры аналитических данных: `data warehouse` (хранилище данных) и `data lake` (озеро данных). Будут раскрыты основные принципы работы каждой архитектуры, их отличия друг от друга и проблемы каждого из этих подходов к управлению аналитическими данными. Знание о принципах работы этих двух архитектур послужит основой для рассмотрения основной темы этой главы: парадигмы сети данных и ее взаимодействия с предметно-ориентированным проектированием.

### Хранилище данных — `Data Warehouse`

Архитектура хранилища данных (`data warehouse, DWH`) относительно проста. Сначала данные извлекаются из всех рабочих систем предприятия, а затем эти исходные данные трансформируются в аналитическую модель и полученный результат загружается в базу данных, ориентированную на анализ этих данных. Именно эта база данных и является хранилищем данных (`data warehouse`).

Эта архитектура управления данными основана главным образом на сценариях извлечения-преобразования-загрузки (`extract-transform-load, ETL`). Данные могут поступать из различных источников: рабочих баз данных, потоковых событий, журналов и т. д. В дополнение к преобразованию исходных данных в модель, основанную на фактах и измерениях, этап преобразования может включать в себя дополнительные операции, такие как удаление конфиденциальных данных, устранение дубликатов записей, изменение порядка событий, объединение мелких событий и др. В ряде случаев преобразование может потребовать временного хранения входящих данных в так называемой области промежуточного хранения (`staging area`).

Образующееся в результате хранилище данных (`data warehouse`), показанное на рис. 16.7, содержит аналитические данные, охватывающие все бизнес-процессы предприятия. Данные предоставляются с использованием языка `SQL` (или одного из его диалектов) и используются аналитиками данных и специалистами по бизнес-аналитике. 

![[Рис. 16.7. Типовая архитектура корпоративного хранилища данных.png]]

Внимательный читатель заметит, что архитектура хранилища данных испытывает ряд тех же трудностей, которые рассматривались в главах 2 и 3.

Прежде всего, в основу архитектуры хранилища данных заложена цель построения модели для всего предприятия. Модель должна описывать данные, создаваемые всеми системами предприятия, и охватывать все возможные сценарии использования аналитических данных. Аналитическая модель позволяет, например, оптимизировать бизнес, снизить эксплуатационные расходы, принимать выверенные бизнес-решения, составлять отчеты и даже формировать модели машинного обучения. Как уже говорилось в главе 3, такой подход имеет смысл только для самых маленьких организаций. Гораздо более эффективным и масштабируемым подходом будет разработка модели для конкретной задачи, например для создания отчетов или формирования моделей машинного обучения.

Задача построения всеобъемлющей модели может быть частично решена за счет использования витрин данных (`data mart`). Это база данных, в которой хранится информация, необходимая для конкретных аналитических потребностей, например для анализа отдельно взятого бизнес-подразделения. В модели витрины данных, показанной на рис. 16.8, одна витрина заполняется непосредственно `ETL`-процессом из транзакционной системы, а другая витрина извлекает свои данные из хранилища данных. 

![[Рис. 16.8. Архитектура корпоративного хранилища данных, дополненная витринами данных.png]]

Когда данные загружаются в витрину данных из корпоративного хранилища данных, все равно нам нужна модель для всего предприятия сразу. В качестве альтернативы витрины данных могут реализовываться за счет применения специализированных `ETL`-процессов, предназначенных для приема данных непосредственно из транзакционных систем. Получающаяся в результате этого модель усложняет получение данных из разных витрин, например по разным отделам, поскольку для этого требуется запрос из разных баз данных, существенно снижающий производительность системы.

Еще один весьма непростой аспект архитектуры хранилища данных связан с тем, что `ETL`-процессы формируют сильную связанность аналитических (`OLAP`) и транзакционных (`OLTP`) систем. Доступ к данным, потребляемым `ETL`-сценариями, осуществляется не только через публичные интерфейсы. Зачастую `DWH`-системы просто извлекают все необходимые данные из баз данных транзакционных систем. Схема, используемая в транзакционной базе данных, относится к деталям внутренней реализации, а не к публичному интерфейсу. В результате даже незначительное изменение схемы неизменно «ломает» `ETL`-скрипты хранилища данных. Поскольку транзакционная и аналитическая системы реализуются и поддерживаются в некотором смысле дистанцированными друг от друга организационными подразделениями, взаимодействие между ними затруднено и приводит к большим трениям между командами. Схема обмена данными показана на рис. 16.9. 

![[Рис. 16.9. Хранилище данных, заполняемое путем извлечения данных.png]]

Избавиться от некоторых недостатков архитектуры хранилища данных позволяет использование архитектуры озера данных (`data lake architecture`).

### Озеро данных — `Data Lake`

Архитектура озера (`Data Lake`) данных, как и архитектура хранилища данных, основана на той же самой концепции приема данных транзакционных систем и преобразования их в аналитическую модель. Но концептуально эти два подхода различаются.

Система на основе озера данных принимает данные транзакционной системы. Но вместо того, чтобы сразу осуществлять их преобразование в аналитическую модель, она сохраняет данные в «сыром» виде, т. е. в исходной транзакционной модели.

В итоге необработанные данные не соответствуют потребностям специалистов, занимающихся их анализом. В результате задача специалистов по данным и специалистов по бизнес-аналитике состоит в том, чтобы разобраться с данными в озере и реализовать `ETL`-скрипты, которые будут создавать аналитические модели и передавать их в хранилище данных. Архитектура озера данных показана на рис. 16.10. 

![[Рис. 16.10. Архитектура озера данных.png]]

Поскольку данные транзакционных систем сохраняются в исходном, необработанном виде и трансформируются только после этого, то благодаря этому озеро данных позволяет работать с несколькими аналитическими моделями, предназначенными для разных задач. Одну модель можно использовать для создания отчетов, другую — для формирования моделей машинного обучения и т. д. Кроме того, в последующем могут быть добавлены новые модели, которые будут проинициализированы уже имеющимися необработанными данными.

Вместе с тем отложенное создание аналитических моделей усложняет всю систему. Специалисты по данным для соответствия различным версиям транзакционной модели нередко реализуют и поддерживают сразу несколько версий одного и того же `ETL`-скрипта (рис. 16.11). 

![[Рис. 16.11. Несколько версий одного и того же ETL-сценария.png]]

Кроме того, поскольку озера данных не содержат схем (на входящие данные не накладываются никакие схемы) и не контролируют качество входящих данных, информация в озере данных при определенных уровнях масштабирования становится хаотичной. Озера данных упрощают получение данных, но существенно усложняют их использование. Или, как часто говорят, озеро данных превращается в болото данных. Обязанность разбираться во всем этом хаосе и извлекать полезные аналитические данные усложняет работу специалиста по данным в десятки раз.

### Проблемы архитектур хранилища данных и озера данных

Архитектуры хранилища данных (`Data Warehouse`) и озера данных (`Data Lake`) основаны на предположении, что чем больше данных поступает для аналитики, тем больше информации получает организация. Но обоим подходам свойственно пасовать под тяжестью больших данных. Преобразование транзакционных моделей в аналитические сводится к тысячам неподдерживаемых специализированных `ETL`-скриптов.

С точки зрения моделирования обе архитектуры посягают на границы транзакционных систем и создают зависимости от деталей своей реализации. Возникающая в результате этого связанность с моделями реализации приводит к конфликтам интересов команд транзакционных и аналитических систем, часто вплоть до отказа от назревших изменений в транзакционных моделях ради того, чтобы не нарушать работу системы анализа с использованием `ETL`-сценариев.

Хуже того, принадлежность аналитиков и специалистов по данным к отдельным подразделениям приводит к их недостаточно глубоким знаниям в области бизнеса по сравнению со специалистами команд разработчиков транзакционных систем. Они специализируются не на знаниях бизнеса, а в основном на умении пользоваться инструментами для работы с большими данными.

И последнее, но не менее важное: связанность с моделями реализации особенно ощутима в проектах, основанных на использовании предметно-ориентированного проектирования, в которых упор делается на постоянное развитие и улучшение моделей предметной области бизнеса. В результате этого изменение транзакционной модели может иметь непредвиденные последствия для аналитической модели. Частота таких изменений в проектах, основанных на использовании предметно-ориентированного проектирования, зачастую является причиной возникновения конфликтных ситуаций между отделами исследований и разработок и отделами обработки данных.

Эти ограничения, присущие хранилищам данных и озерам данных, вдохновили на создание новой архитектуры управления аналитическими данными: сети данных (`data mesh`).

# Сеть данных (`Data Mesh`)

Архитектура сети данных (`data mesh`) в некотором смысле представляет собой предметно-ориентированное проектирование применительно к аналитическим данным. Поскольку различные `DDD`-паттерны устанавливают границы и защищают свое содержимое, архитектура сети данных (`data mesh`) определяет и защищает границы модели аналитических данных.

Архитектура сети данных (`data mesh`) основана на четырех основных принципах: разбиение данных по предметным областям, рассмотрение данных как продукта, обеспечение автономии и построение экосистемы. Рассмотрим особенности каждого из них.

## Разбиение данных по предметным областям

Подходы, используемые как в хранилище данных, так и в озере данных, направлены на объединение всех данных предприятия в одну большую модель. Полученная аналитическая модель неэффективна по тем же причинам, что и транзакционная модель в масштабах всего предприятия. Кроме того, сбор данных со всех систем в одном месте приводит к стиранию границ владения различными элементами данных.

Вместо создания монолитной аналитической модели архитектура сети данных требует использования того же решения для рабочих данных, которое уже рассматривалось в главе 3: использовать несколько аналитических моделей и поддерживать их согласованность с источником данных. Это, как показано на рис. 16.12, совершенно естественным образом приводит границы владения аналитическими моделями в соответствие с границами ограниченных контекстов. Когда модель анализа разбивается в соответствии с имеющимися в системе ограниченными контекстами, генерация данных анализа становится обязанностью соответствующих групп разработчиков. 

![[Рис. 16.12. Приведение границ владения аналитическими моделями в соответствие с границами ограниченных контекстов.png]]

Каждый ограниченный контекст теперь владеет своей транзакционной (`OLTP`) и аналитической (`OLAP`) моделями. Следовательно, та команда, которая владеет транзакционной моделью, теперь отвечает и за ее преобразование в аналитическую модель.

## Данные как продукт

Классические архитектуры управления данными затрудняют исследование, понимание и выборку качественных аналитических данных. Особенно остро это проявляется при использовании озер данных (`data lakes`).

Восприятие данных в качестве продукта требует относиться к аналитическим данным как к одним из важнейших активов компании. Вместо снабжения аналитических систем оперативными данными из сомнительных источников (внутренней базы данных, файлов журналов и т. д.) в системе на основе сети данных (`data mesh`) ограниченные контексты обслуживают аналитические данные через конкретные выходные порты (см. рис. 16.13). 

![[Рис. 16.13. Конечные точки данных Polyglo.png]]

С аналитическими данными следует обращаться так же, как и с любым публичным `API`-интерфейсом:

*   Должны быть легко обнаруживаемые нужные эндпоинты: порты вывода данных.
*   Аналитические эндпоинты должны иметь четко определенную схему, содержащую описание обслуживаемых данных и их формат.
*   Аналитические данные должны быть достоверными, и как и в случае с любым `API`-интерфейсом, у него должны быть вполне определенные и отслеживаемые соглашения об уровне обслуживания (`service-level agreements, SLA`).
*   У аналитической модели должна быть версия в виде обычного `API`-интерфейса, и она должна надлежащим образом работать с обратно несовместимыми изменениями.

Кроме того, поскольку аналитические данные воспринимаются в качестве продукта, они должны удовлетворять нуждам своих потребителей. Команда, работающая над реализацией ограниченного контекста, отвечает за то, чтобы создаваемая модель отвечала нуждам ее потребителей. В отличие от архитектур хранилища данных и озера данных, при использовании сети данных ответственность за качество данных является задачей с наивысшим приоритетом.

Цель архитектуры управления распределенными данными состоит в том, чтобы предоставить возможность объединения детализированных аналитических моделей для удовлетворения потребностей организации в анализе данных. Например, если `BI`-отчет должен отражать данные, взятые из нескольких ограниченных контекстов, ему в случае необходимости должна предоставляться возможность без особых затруднений извлекать аналитические данные этих контекстов, применять локальные преобразования и создавать отчет.

И наконец, разным потребителям могут потребоваться аналитические данные в разной форме. Одни потребители могут отдавать предпочтение выполнению `SQL`-запросов, а другие — получать аналитические данные из сервиса хранения объектов и т. д. По этой причине информационные продукты должны поддерживать разные типы хранилищ, предоставляя данные в форматах, удовлетворяющих разнообразные нужды потребителей.

Чтобы реализовать принцип восприятия данных в качестве продукта, командам по разработке продуктов необходимо добавить в свой состав специалистов по работе с данными. Это и есть недостающая часть пазла кросс-функциональных команд, в который традиционно входят только специалисты, связанные с транзакционными системах.

## Обеспечение автономии

У команд разработчиков должна быть возможность не только создавать свои собственные продукты данных, но и использовать продукты данных, обслуживаемые другими командами разработчиков ограниченных контекстов. Как и в случае с ограниченными контекстами, продукты данных должны быть совместимы.

Было бы расточительно, неэффективно и сложно проводить интеграцию, если бы каждая команда для обслуживания аналитических данных создавала свое собственное решение. Чтобы такого не случалось, необходима платформа, позволяющая абстрагироваться от сложностей создания, выполнения и обслуживания совместимых продуктов данных. Проектирование и создание такой платформы является серьезной задачей и требует специальной команды разработчиков платформы инфраструктуры данных.

Команда разработчиков платформы инфраструктуры данных должна отвечать за определение шаблонов продуктов данных, унифицированных способов доступа, контроля доступа и децентрализации способов хранения данных (`polyglot persistence`), которыми могли бы воспользоваться группы разработчиков продуктов, а также за мониторинг платформы и обеспечение выполнения `SLA`-соглашений и показателей.

## Построение экосистемы

Завершающим шагом к созданию системы сети данных является назначение объединенного органа управления для обеспечения функциональной совместимости и экосистемного мышления в области аналитических данных. Как правило, как показано на рис. 16.14, это группа, состоящая из владельцев данных и продуктов ограниченных контекстов, а также представителей команды платформы инфраструктуры данных. 

![[Рис. 16.14. Группа управления.png]]

Группа управления отвечает за определение правил, обеспечивающих работоспособную и функционально совместимую экосистему. Правила должны применяться ко всем продуктам данных и их интерфейсам, и ответственность за соблюдение этих правил в масштабах всего предприятия возлагается на эту группу.

## Совмещение сети данных (`data mesh`) и предметно-ориентированного проектирования

Итак, рассмотрены все четыре принципа, на которых основана архитектура `data mesh`. Акцент, сделанный на определении границ и инкапсуляции деталей реализации путем использования конкретных выходных портов, позволяет сделать вывод, что архитектура сети данных основана на тех же соображениях, что и предметно-ориентированное проектирование. Кроме того, некоторые из паттернов предметно-ориентированного проектирования, могут во многом поддерживать реализацию архитектуры сети данных (`data mesh`).

Во-первых, для разработки аналитических моделей необходимы единый язык (`ubiquitous language`) и полученные знания о предметной области. Как уже говорилось в разделах, посвященных хранилищам данных и озерам данных, в традиционных архитектурах отсутствуют знания предметной области.

Во-вторых, предоставление данных ограниченного контекста в модели, отличной от его транзакционной модели, является паттерном сервиса с открытым протоколом (`open-host service`). В этом случае аналитическая модель является дополнительным опубликованным языком (`published language`).

`CQRS` упрощает создание нескольких моделей одних и тех же данных. Им можно воспользоваться для преобразования транзакционной модели в аналитическую модель. Способность `CQRS` генерировать модели с нуля упрощает одновременное создание и обслуживание сразу нескольких версий аналитической модели (рис. 16.15). 

![[Рис. 16.15. Использование паттерна CQRS для одновременного предоставления аналитических данных.png]]

И наконец, поскольку архитектура `data mesh` объединяет модели различных ограниченных контекстов для реализации аналитических сценариев использования, паттерны интеграции ограниченных контекстов для транзакционных моделей применимы и к аналитическим моделям. Две команды разработки продуктов могут развивать свои аналитические модели совместными усилиями. А какая-нибудь другая команда может внедрить предохранительный слой (`anticorruption layer`), чтобы защитить себя от неэффективной аналитической модели. Или же команды могут пойти разными путями и создать дублирующие реализации аналитических моделей.

## Вывод

В этой главе были представлены различные аспекты проектирования программных систем, в частности приемы определения аналитических данных и управление ими. Были рассмотрены доминирующие модели аналитических данных, в том числе схемы «звезда» и «снежинка», а также способы традиционного управления данными в хранилищах данных и озерах данных.

Проблемы традиционных архитектур управления данными призвана решить архитектура сети данных (`data mesh`). По сути, в ней применяются те же принципы, что и в предметно-ориентированном проектировании, но обращенные к аналитическим данным: разбиение аналитической модели на управляемые части, обеспечение надежного доступа к аналитическим данным и их использование через публичные интерфейсы. В итоге реализацию архитектуры сети данных (`data mesh`) могут поддерживать `CQRS` и паттерны интеграций ограниченных контекстов.