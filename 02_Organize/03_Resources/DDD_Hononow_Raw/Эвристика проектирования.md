---
updated_at: 2025-12-12T15:06:10.885+10:00
tags:
  - part3
  - chapter10
---
«По обстоятельствам» — правильный, но не вполне практичный ответ почти на любой вопрос в области разработки программных средств. В этой главе мы рассмотрим, от чего это «все зависит».

В первой части книги рассматривались инструменты предметно-ориентированного проектирования, предназначенные для анализа предметных областей и принятия стратегических проектных решений. Во второй части рассматривались тактические паттерны проектирования: различные способы реализации бизнес-логики, организации архитектуры системы и коммуникации между компонентами системы. Эта глава объединяет первую и вторую части. Здесь будут рассмотрены эвристические приемы применения инструментов анализа для принятия различных решений по проектированию программных средств: т. е. предметно-ориентированного (бизнес) проектирования (программных средств).

Но сначала, поскольку эта глава посвящена эвристике проектирования, давайте начнем с определения самого понятия эвристики.

### Эвристика

Эвристика — это не строгое правило, состоятельность которого гарантированно и математически доказана в 100% случаев. Скорее, это правило из разряда эмпирических: совершенство не гарантируется, но достаточность для достижения непосредственных целей, несомненно, имеется. Иными словами, использование эвристики — это эффективный подход к решению задач, игнорирующий шум, присущий многим сигналам. Эвристика позволяет сконцентрировать внимание на «превалирующих силах», отраженных в наиболее важных сигналах.

Эвристики, представленные в этой главе, сосредоточены на основных свойствах различных предметных областей и на сущностях задач, решаемых с помощью различных проектных решений.

### Ограниченные контексты

Как следует из усвоенного при изучении главы 3, под определение корректного ограниченного контекста (`bounded context`) могут подходить как широкие, так и узкие границы, охватываемые применением непротиворечивого единого языка (`ubiquitous language`). И все же каков оптимальный размер ограниченного контекста? Этот вопрос особенно важен в свете частого отождествления ограниченных контекстов с микросервисами. Нужно ли неизменно стремиться к наименьшим возможным ограниченным контекстам? Как говорит мой друг Ник Тьюн (`Nick Tune`):

> Для определения границ сервиса существует множество полезных и показательных эвристик. И его размер относится к разряду наименее полезных.

Вместо превращения модели в функцию желаемого размера (проводя оптимизацию под небольшие ограниченные контексты) гораздо эффективнее сделать обратное: рассматривать размер ограниченного контекста как функцию модели, которую он охватывает.

Изменения в программных средствах, влияющих сразу на несколько ограниченных контекстов, обходятся дорого и требуют тщательной согласованности, особенно если затрагиваемые ограниченные контексты реализуются разными командами. Подобные изменения, не инкапсулированные в один ограниченный контекст, сигнализируют о неэффективном определении границ контекстов. К сожалению, реструктуризация границ ограниченного контекста является весьма дорогостоящим делом, и во многих случаях неэффективность границ обходят стороной, что в конечном итоге приводит к накоплению технического долга (см. рис. 10.1). Рис. 10.1. Изменение, затрагивающее сразу несколько ограниченных контекстов

![[Рис. 10.1. Изменение, затрагивающее сразу несколько ограниченных контекстов.png]]

Изменения, нарушающие границы ограниченных контекстов, обычно происходят, когда предметная область недостаточно изучена или бизнес-требования подвержены частым изменениям. Из главы 1 известно, что основным поддоменам (`core subdomains`), особенно на ранних этапах их реализации, присущи как изменчивость, так и неопределенность. Этим обстоятельством можно воспользоваться в качестве эвристики проектирования границ ограниченных контекстов.

Широкие границы ограниченного контекста, или же границы, охватывающие сразу несколько поддоменов, делают менее опасными как ошибки в определении границ, так и ошибки в моделировании входящих в них поддоменов. Реструктуризация логических границ обходится значительно дешевле, чем переопределение физических границ. Следовательно, при разработке ограниченных контекстов следует начинать с границ с более широким охватом. При необходимости, по мере приобретения знаний предметной области, широкие границы нужно сузить.

Такая эвристика применяется в основном к ограниченным контекстам, охватывающим основные поддомены (`core subdomains`), поскольку как универсальные (`generic`), так и вспомогательные (`supporting`) подобласти отличаются большей сформулированностью и гораздо меньшей изменчивостью. При создании ограниченного контекста, содержащего основной поддомен (`core subdomain`), от непредвиденных изменений можно защититься, включив в него другие поддомены, с которыми основной поддомен взаимодействует чаще всего. Это, как показано на рис. 10.2, могут быть другие основные, или даже вспомогательные, или универсальные подобласти. 

![[Рис. 10.2. Широкие границы ограниченного контекста.png]]

## Паттерны реализации бизнес-логики

В главах 5–7, где подробно обсуждалась бизнес-логика, были раскрыты четыре различных способа ее моделирования: транзакционный сценарий (`transaction script`), активная запись (`active record`), модель предметной области (`domain model`) и паттерны модели предметной области, основанной на событиях (`event-sourced domain model`).

И транзакционный сценарий, и активная запись больше подходят для поддоменов с простой бизнес-логикой: например, для вспомогательных (`supporting`) подобластей или для интеграции стороннего решения в универсальную (`generic`) подобласть. Разница между этими двумя паттернами заключается в сложности структур данных. Транзакционный сценарий можно использовать для простых структур данных, а активная запись помогает инкапсулировать маппинг сложных структур данных в базу данных.

Модель предметной области и ее вариант, модель предметной области, основанная на событиях (`event-sourced domain model`), больше подходят для поддоменов со сложной бизнес-логикой, т. е. для основных (`core`) поддоменов. Для тех же основных поддоменов, которые имеют дело с финансовыми транзакциями и выполняют обязательства перед законом по предоставлению журнала аудита или же требуют глубокой аналитики поведения системы, больше подойдут модели предметной области, основанные на событиях.

С учетом вышеизложенного эффективная эвристика выбора подходящего паттерна реализации бизнес-логики состоит в том, чтобы задаться следующими вопросами:

 - Отслеживаются ли поддоменом деньги или другие денежные операции, должен ли он предоставлять надлежащий журнал аудита или требуется ли бизнесу глубокий анализ ее поведения? Если да, следует воспользоваться моделью предметной области, основанной на событиях (`event-sourced domain model`). Если нет, то...
 - Отличается ли бизнес-логика поддомена особой сложностью? Если да, нужно озаботиться реализацией модели предметной области. Если нет, то...
 - Включает ли поддомен сложные структуры данных? Если да, следует воспользоваться паттерном «Активная запись». Если нет, то...
 - Следует реализовать транзакционный сценарий.

Благодаря существованию тесной связи между сложностью поддомена и его типом эвристику, как показано на рис. 10.3, можно визуализировать, используя предметно-ориентированное дерево решений. 

![[Рис. 10.3. Дерево решений для выбора паттерна реализации бизнес-логики.png]]

Для определения разницы между сложной и простой бизнес-логикой можно воспользоваться другой эвристикой. Граница между этими двумя типами бизнес-логики не очень четкая, но важная. Как правило, сложная бизнес-логика включает в себя составные бизнес-правила, инварианты и алгоритмы. А простой подход касается в основном проверки входных данных. Еще одна эвристика для оценки сложности касается замысловатости самого единого языка. Что положено в его основу — описание `CRUD`-операций или же описание более сложных бизнес-процессов и правил?

Принятие решения о паттерне реализации бизнес-логики, сообразующемся с ее сложностью и структурами данных, — это способ проверки ваших предположений о типе поддомена. Предположим, что поддомен считается основным (`core`), но наиболее подходящим видится шаблон активной записи или транзакционный сценарий. Или же предположим, что подобласть считается вспомогательной (`supporting`), но требует модели предметной области или модели предметной области, основанной на событиях (`event-sourced domain model`), в таких случаях появляется отличная возможность пересмотреть свои предположения о поддомене и о предметной области в целом. Следует помнить, что конкурентное преимущество основного поддомена не обязательно должно замыкаться на техническую составляющую.

## Архитектурные паттерны

В главе 8 рассматривались три архитектурных паттерна: слоистая архитектура, порты и адаптеры и `CQRS`.

Выявление предполагаемого паттерна реализации бизнес-логики упрощает выбор архитектурного паттерна:

- Для модели предметной области, основанной на событиях, требуется `CQRS`. В противном случае система будет крайне ограничена в возможностях запроса данных, извлекая только один конкретный инстанс агрегата по его идентификатору.
 - Модель предметной области требует использования архитектуры портов и адаптеров. В противном случае слоистая архитектура затруднит реализацию агрегатов и объектов-значений, ничего не знающих о системах хранения данных.
 - Паттерн активной записи удачнее всего сочетается с многоуровневой архитектурой с дополнительным прикладным уровнем (сервисом) для логики, управляющей активными записями.
 - Паттерн транзакционного сценария может быть реализован с минимальной слоистой архитектурой, состоящей всего из трех уровней (трехслойной).

Единственным исключением из предыдущей эвристики является шаблон `CQRS`. Он может быть полезен не только для модели предметной области, основанной на событиях (`event-sourced domain model`), но и для любого другого паттерна, если поддомену требуется представление о своих данных в нескольких моделях хранения.

Дерево решений для выбора архитектурного шаблона на основе этих эвристик показано на рис. 10.4.

![[Рис. 10.4. Дерево решений по выбору архитектурного паттерна.png]]

## Стратегия тестирования

Представлением о паттерне реализации бизнес-логики и об архитектурном шаблоне можно воспользоваться в качестве эвристики для выбора стратегии тестирования кодовой базы. Взгляните на три стратегии тестирования, показанные на рис. 10.5. 

![[Рис. 10.5. Стратегии тестирования.png]]

Разница между стратегиями тестирования на рисунке заключается в том, что они акцентируют внимание на различных типах тестов: модульных, интеграционных и сквозных. Давайте проанализируем каждую стратегию и контекст, в котором следует использовать каждую модель.

### Пирамида тестирования

В классической пирамиде тестирования особое внимание уделяется модульным тестам, меньшее — интеграционным и еще меньшее — сквозным. Пирамиды тестирования лучше всего подходят обоим вариантам шаблонов модели предметной области. А из агрегатов и объектов-значений получаются идеальные компоненты для эффективного тестирования бизнес-логики.

### Ромб тестирования

Ромб тестирования в основном концентрируется на интеграционных тестах. Когда используется шаблон активной записи, бизнес-логика системы по определению распространяется как на сервисный слой, так и на слой бизнес-логики. То есть, чтобы сосредоточиться на интеграции двух слоев, более эффективным выбором является ромб тестирования.

### Перевернутая пирамида тестирования

В перевернутой пирамиде тестирования наибольшее внимание уделяется сквозным тестам: проверке рабочего процесса приложения от начала до конца. Такой порядок больше всего подходит для кодовых баз, реализующих паттерн «Транзакционный сценарий»: бизнес-логика проста, а количество уровней минимально, что делает более эффективной проверку сквозного потока операций, проводимых в системе.

Дерево решений по стратегии тестирования показано на рис. 10.6. 

![[Рис. 10.6. Дерево решений по стратегии тестирования.png]]

## Дерево тактических проектных решений

Паттерны бизнес-логики, архитектурные паттерны и эвристики стратегии тестирования можно, как показано на рис. 10.7, объединить и обобщить с помощью дерева тактических проектных решений.

![[Рис. 10.7. Дерево тактических проектных решений.png]]

Как видите, определение типов поддоменов и следование дереву решений дает надежную отправную точку для принятия важных проектных решений. И тем не менее стоит повторить, что это эвристика, а не жесткие правила. Из каждого правила есть исключения, не говоря уже об эвристиках, которые по определению не должны быть правильными в 100% случаев. 

Дерево решений основано на моем предпочтении в использовании простых инструментов и в применении расширенных шаблонов — модели предметной области, модели предметной области, основанной на событиях, `CQRS` и т. д. — только в случае крайней необходимости. И все же мне встречались команды, имеющие большой опыт реализации модели предметной области, основанной на событиях, в силу чего она использовалась ими для всех создаваемых поддоменов. Для них это было проще использования разных паттернов. Можно ли порекомендовать этот подход всем? Конечно, нет. В компаниях, в которых я работал или оказывал консультационные услуги, эвристический подход оказался более эффективным по сравнению с использованием одного и того же решения для каждой задачи.

В конце концов, все зависит от вашего конкретного контекста. Деревом решений, показанным на рис. 10.7, и эвристикой проектирования, на котором она основана, можно воспользоваться в качестве руководящих принципов, но никак не в качестве замены критического мышления. Если обнаружится, что лучше подходят альтернативные эвристики, не стесняйтесь изменять руководящие принципы или вообще выстраивать собственное дерево решений.

## Вывод

Эта глава соединяет первую и вторую части книги и эвристический фреймворк принятия решений. В ней был рассмотрен порядок применения знаний о предметной области и ее поддоменах для принятия технических решений: выбора безопасных границ ограниченных контекстов, моделирования бизнес-логики приложения и определения архитектурного шаблона, необходимого для организации взаимодействия внутренних компонентов каждого ограниченного контекста. В конце главы мы затронули тему, которая часто является предметом бурных дискуссий, — какой вид тестов важнее, при этом для определения приоритетов различных тестов в соответствии с предметной областью использовался тот же фреймворк принятия решений.

Важнее самого принятия проектных решений — проверка их обоснованности с течением времени. В следующей главе обсуждение будет перенесено на следующую фазу жизненного цикла разработки программных средств: эволюцию проектных решений.